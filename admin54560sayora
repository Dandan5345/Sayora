<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sayora Festival - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-surface: #1E1E1E;
            --primary-gold: #c09a3e;
            --primary-gold-hover: #d4af37;
            --text-light: #E0E0E0;
            --border-color: #444444;
        }
        body { font-family: 'Assistant', sans-serif; background-color: var(--bg-dark); color: var(--text-light); }
        .modal-backdrop { background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: var(--bg-surface); border: 1px solid var(--border-color); max-height: 85vh; overflow-y: auto; }
        .form-input, .form-select, .form-textarea { background-color: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-light); border-radius: 0.5rem; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-gold); box-shadow: 0 0 0 2px rgba(192, 154, 62, 0.4); }
        .btn { border-radius: 0.5rem; font-weight: bold; padding: 0.6rem 1.2rem; transition: all 0.3s; cursor: pointer; }
        .btn-primary { background-color: var(--primary-gold); color: var(--bg-dark); }
        .btn-primary:hover { background-color: var(--primary-gold-hover); transform: translateY(-2px); }
        .btn-primary:disabled { background-color: #555; color: #999; cursor: not-allowed; transform: none; }
        .btn-secondary { background-color: #333; color: var(--text-light); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: #444; }
        .toggle-bg:after { content: ''; position: absolute; top: 2px; left: 2px; background: white; border-radius: 50%; transition: 0.3s; width: 20px; height: 20px; }
        input:checked + .toggle-bg:after { transform: translateX(100%); }
        input:checked + .toggle-bg { background: var(--primary-gold); }
        .item-card { cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .item-card:hover { background-color: #2a2a2a; transform: translateY(-3px); }
        .progress-bar-bg { background-color: #333; }
        .progress-bar-fg { background-color: var(--primary-gold); transition: width 0.2s ease-in-out; }
    </style>
</head>
<body class="antialiased">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex-col gap-4 justify-center items-center z-50 hidden">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2" style="border-color: var(--primary-gold);"></div>
        <p id="loading-text" class="text-lg">×˜×•×¢×Ÿ...</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b-2 pb-6" style="border-color: var(--primary-gold);">
            <div class="flex items-center gap-4">
                <img src="https://i.imgur.com/fYUvEiv.png" alt="Sayora Festival Logo" class="w-20 h-20 md:w-24 md:h-24 rounded-full shadow-lg" style="box-shadow: 0 0 15px var(--primary-gold);">
                <h1 class="text-3xl md:text-5xl font-bold text-white tracking-wider">SAYORA<span style="color: var(--primary-gold);"> FESTIVAL</span></h1>
            </div>
            <div class="mt-6 md:mt-0">
                 <button id="scan-qr-btn" class="btn btn-primary text-lg">×¡×¨×•×§ ×‘×¨×§×•×“</button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-transparent p-6 rounded-lg shadow-lg border border-gray-800">
                    <h2 class="text-2xl font-semibold mb-4" style="color: var(--primary-gold);">× ×™×”×•×œ ××ª×¨×™×</h2>
                    <button id="add-site-btn" class="w-full btn btn-primary mb-4">×”×•×¡×£ ××ª×¨ ×—×“×©</button>
                    <div id="sites-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
                <div class="bg-transparent p-6 rounded-lg shadow-lg border border-gray-800">
                    <h2 class="text-2xl font-semibold mb-4" style="color: var(--primary-gold);">× ×™×”×•×œ ×× ×”×œ×™×</h2>
                    <button id="add-manager-btn" class="w-full btn btn-primary mb-4">×”×•×¡×£ ×× ×”×œ ×—×“×©</button>
                    <div id="managers-list" class="space-y-3 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            <div class="bg-transparent p-6 rounded-lg shadow-lg lg:col-span-2 border border-gray-800">
                <h2 class="text-2xl font-semibold mb-4" style="color: var(--primary-gold);">× ×™×”×•×œ ×¤×¨×•×¤×™×œ×™×</h2>
                <button id="add-profile-btn" class="w-full btn btn-primary mb-4">×”×•×¡×£ ×¤×¨×•×¤×™×œ ×—×“×©</button>
                 <div id="profiles-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[34rem] overflow-y-auto p-2"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="site-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-md"><h3 id="site-modal-title" class="text-2xl font-bold mb-6">×”×•×¡×£ ××ª×¨ ×—×“×©</h3><form id="site-form"><input type="hidden" id="site-id"><div class="mb-4"><label for="site-name" class="block mb-2">×©× ×”××ª×¨ <span class="text-red-500">*</span></label><input type="text" id="site-name" class="w-full p-2 form-input" required></div><div class="mb-6"><label for="site-details" class="block mb-2">×¤×™×¨×•×˜</label><textarea id="site-details" class="w-full p-2 form-textarea" rows="3"></textarea></div><div class="flex justify-end gap-4"><button type="button" class="btn btn-secondary cancel-modal-btn">×‘×™×˜×•×œ</button><button type="submit" class="btn btn-primary">×©××•×¨</button></div></form></div></div>
    <div id="manager-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-lg"><h3 id="manager-modal-title" class="text-2xl font-bold mb-6">×”×•×¡×£ ×× ×”×œ ×—×“×©</h3><form id="manager-form" novalidate><input type="hidden" id="manager-id"><input type="hidden" id="manager-image-url"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="manager-name" class="block mb-2">×©× ××œ× <span class="text-red-500">*</span></label><input type="text" id="manager-name" class="w-full p-2 form-input" required></div><div><label for="manager-phone" class="block mb-2">××¡×¤×¨ ×˜×œ×¤×•×Ÿ <span class="text-red-500">*</span></label><input type="tel" id="manager-phone" class="w-full p-2 form-input" required></div><div><label for="manager-id-number" class="block mb-2">×ª×¢×•×“×ª ×–×”×•×ª <span class="text-red-500">*</span></label><input type="text" id="manager-id-number" class="w-full p-2 form-input" required></div><div><label for="manager-sites" class="block mb-2">××ª×¨×™× ××•×¨×©×™× <span class="text-red-500">*</span></label><select id="manager-sites" class="w-full p-2 form-select" multiple required></select></div><div class="md:col-span-2"><label for="manager-responsibility" class="block mb-2">××—×¨×™×•×ª <span class="text-red-500">*</span></label><textarea id="manager-responsibility" class="w-full p-2 form-textarea" rows="3" required></textarea></div><div class="md:col-span-2"><label for="manager-image-input" class="block mb-2">×ª××•× ×ª ×¤×¨×•×¤×™×œ <span class="text-red-500">*</span></label><input type="file" id="manager-image-input" class="w-full p-2 text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold" style="color: var(--primary-gold); --tw-ring-color: var(--primary-gold);" accept="image/*"><div id="manager-image-status" class="text-sm mt-2"></div><div id="manager-upload-progress" class="hidden mt-2"><div class="progress-bar-bg w-full rounded-full h-2.5"><div id="manager-progress-bar" class="progress-bar-fg h-2.5 rounded-full" style="width: 0%"></div></div><div id="manager-upload-status" class="text-sm text-center mt-1"></div></div></div></div><div class="flex justify-end gap-4 mt-6"><button type="button" class="btn btn-secondary cancel-modal-btn">×‘×™×˜×•×œ</button><button type="submit" id="save-manager-btn" class="btn btn-primary">×©××•×¨ ×× ×”×œ</button></div></form></div></div>
    <div id="profile-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-lg"><h3 id="profile-modal-title" class="text-2xl font-bold mb-6">×”×•×¡×£ ×¤×¨×•×¤×™×œ ×—×“×©</h3><form id="profile-form" novalidate><input type="hidden" id="profile-id"><input type="hidden" id="profile-image-url"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="profile-name" class="block mb-2">×©× ××œ× <span class="text-red-500">*</span></label><input type="text" id="profile-name" class="w-full p-2 form-input" required></div><div><label for="profile-phone" class="block mb-2">××¡×¤×¨ ×˜×œ×¤×•×Ÿ <span class="text-red-500">*</span></label><input type="tel" id="profile-phone" class="w-full p-2 form-input" required></div><div><label for="profile-id-number" class="block mb-2">×ª×¢×•×“×ª ×–×”×•×ª <span class="text-red-500">*</span></label><input type="text" id="profile-id-number" class="w-full p-2 form-input" required></div><div><label for="profile-role" class="block mb-2">×ª×¤×§×™×“ <span class="text-red-500">*</span></label><input type="text" id="profile-role" class="w-full p-2 form-input" required></div><div><label for="profile-manager" class="block mb-2">×× ×”×œ ××—×¨××™ <span class="text-red-500">*</span></label><select id="profile-manager" class="w-full p-2 form-select" required></select></div><div><label for="profile-sites" class="block mb-2">×’×™×©×” ×œ××ª×¨×™× <span class="text-red-500">*</span></label><select id="profile-sites" class="w-full p-2 form-select" multiple required></select></div><div class="md:col-span-2"><label for="profile-image-input" class="block mb-2">×ª××•× ×ª ×¤×¨×•×¤×™×œ <span class="text-red-500">*</span></label><input type="file" id="profile-image-input" class="w-full p-2 text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold" style="color: var(--primary-gold); --tw-ring-color: var(--primary-gold);" accept="image/*"><div id="profile-image-status" class="text-sm mt-2"></div><div id="profile-upload-progress" class="hidden mt-2"><div class="progress-bar-bg w-full rounded-full h-2.5"><div id="profile-progress-bar" class="progress-bar-fg h-2.5 rounded-full" style="width: 0%"></div></div><div id="profile-upload-status" class="text-sm text-center mt-1"></div></div></div><div class="flex items-center md:col-span-2"><label class="block mr-4">×¤×¨×•×¤×™×œ ×¤×¢×™×œ</label><div class="relative inline-block w-12 mr-2 align-middle select-none"><input type="checkbox" name="toggle" id="profile-active" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/><label for="profile-active" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer toggle-bg"></label></div></div></div><div class="flex justify-end gap-4 mt-4"><button type="button" class="btn btn-secondary cancel-modal-btn">×‘×™×˜×•×œ</button><button type="submit" id="save-profile-btn" class="btn btn-primary">×©××•×¨ ×¤×¨×•×¤×™×œ</button></div></form></div></div>
    <div id="details-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-md text-center"><h3 id="details-modal-title" class="text-2xl font-bold mb-4" style="color: var(--primary-gold);"></h3><div id="details-modal-content" class="text-left space-y-2"></div><div id="details-modal-qr-code" class="flex justify-center my-6"></div><div class="text-center mt-4"><button type="button" class="btn btn-secondary" id="close-details-modal">×¡×’×•×¨</button></div></div></div>
    <div id="scanner-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-lg"><h3 class="text-2xl font-bold mb-6 text-center">×¡×¨×•×§ ×§×•×“ QR</h3><div id="reader" class="w-full bg-gray-800 rounded-lg overflow-hidden"></div><div class="text-center mt-4"><button type="button" class="btn btn-secondary" id="cancel-scanner-modal">×¡×’×•×¨</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyAUdX5OhKdNVvXTwVMF6zul6zGhldqx_s0", authDomain: "sayora-786c4.firebaseapp.com", projectId: "sayora-786c4", storageBucket: "sayora-786c4.firebasestorage.app", messagingSenderId: "353491525675", appId: "1:353491525675:web:0c59e5183e112e9bf84a6e" };
        const IMGBB_API_KEY = "1be5a3162de22aed0f431b25ffb4b6cb"; // API key from user's example

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const siteModal = document.getElementById('site-modal');
        const managerModal = document.getElementById('manager-modal');
        const profileModal = document.getElementById('profile-modal');
        const detailsModal = document.getElementById('details-modal');
        let html5QrcodeScanner;

        const showLoading = (text = '×˜×•×¢×Ÿ...') => { document.getElementById('loading-text').textContent = text; loadingOverlay.style.display = 'flex'; }
        const hideLoading = () => loadingOverlay.style.display = 'none';
        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';

        document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal-backdrop').style.display = 'none'));
        document.getElementById('close-details-modal').addEventListener('click', () => closeModal(detailsModal));

        const uploadImageWithProgress = (file, progressElements) => {
            return new Promise((resolve, reject) => {
                const { container, bar, status } = progressElements;
                container.classList.remove('hidden');
                status.textContent = '×××™×¨ ×ª××•× ×”...'; bar.style.width = '5%';
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    const formData = new FormData();
                    formData.append('key', IMGBB_API_KEY);
                    formData.append('image', base64);
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', 'https://api.imgbb.com/1/upload');
                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percent = Math.min(95, 10 + (e.loaded / e.total) * 85);
                            bar.style.width = `${percent}%`;
                            status.textContent = `××¢×œ×”... ${Math.round(percent)}%`;
                        }
                    };
                    xhr.onload = () => {
                        try {
                            const json = JSON.parse(xhr.responseText);
                            if (xhr.status >= 200 && xhr.status < 300 && json.success) {
                                bar.style.width = '100%'; status.textContent = '×”×¢×œ××” ×”×•×©×œ××”!';
                                resolve(json.data.display_url);
                            } else { reject(new Error(json.error?.message || `×©×’×™××ª ×©×¨×ª: ${xhr.status}`)); }
                        } catch (err) { reject(new Error('×ª×’×•×‘×” ×œ× ×ª×§×™× ×” ××”×©×¨×ª.')); }
                    };
                    xhr.onerror = () => reject(new Error('×©×’×™××ª ×¨×©×ª, ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ-ImgBB.'));
                    xhr.send(formData);
                };
                reader.onerror = () => reject(new Error('×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×¨×•× ××ª ×§×•×‘×¥ ×”×ª××•× ×”.'));
                reader.readAsDataURL(file);
            });
        };
        
        // Handle image upload immediately on file selection
        const handleImageSelection = async (e, formType) => {
            const file = e.target.files[0];
            if (!file) return;

            const saveBtn = document.getElementById(`save-${formType}-btn`);
            const imageUrlInput = document.getElementById(`${formType}-image-url`);
            const progressElements = {
                container: document.getElementById(`${formType}-upload-progress`),
                bar: document.getElementById(`${formType}-progress-bar`),
                status: document.getElementById(`${formType}-upload-status`)
            };
            
            saveBtn.disabled = true;
            saveBtn.textContent = '××¢×œ×” ×ª××•× ×”...';
            imageUrlInput.value = '';
            progressElements.status.textContent = '';
            document.getElementById(`${formType}-image-status`).innerHTML = '';

            try {
                const url = await uploadImageWithProgress(file, progressElements);
                imageUrlInput.value = url;
                progressElements.status.innerHTML = `<span style="color: var(--primary-gold);">×”×ª××•× ×” ××•×›× ×” ×œ×©××™×¨×”!</span>`;
            } catch (error) {
                console.error("Image upload failed:", error);
                progressElements.status.innerHTML = `<span class="text-red-500">×©×’×™××” ×‘×”×¢×œ××”: ${error.message}</span>`;
                e.target.value = ''; 
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = `×©××•×¨ ${formType === 'profile' ? '×¤×¨×•×¤×™×œ' : '×× ×”×œ'}`;
            }
        };

        document.getElementById('profile-image-input').addEventListener('change', (e) => handleImageSelection(e, 'profile'));
        document.getElementById('manager-image-input').addEventListener('change', (e) => handleImageSelection(e, 'manager'));

        // Generic Form Setup
        const setupForm = (formId, modal, openBtnId, collectionName, getFormData, openModalFn) => {
            const form = document.getElementById(formId);
            document.getElementById(openBtnId).addEventListener('click', () => openModalFn());
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!form.checkValidity()) { form.reportValidity(); return; }
                const saveBtn = form.querySelector('button[type="submit"]');
                saveBtn.disabled = true;
                showLoading('×©×•××¨ × ×ª×•× ×™×...');
                try {
                    const { data, id, needsImage } = getFormData();
                    if (needsImage && !data.imageUrl) throw new Error("×™×© ×œ×”×¢×œ×•×ª ×ª××•× ×” ×œ×¤× ×™ ×”×©××™×¨×”.");
                    if (id) await updateDoc(doc(db, collectionName, id), data);
                    else await addDoc(collection(db, collectionName), data);
                    closeModal(modal);
                } catch (error) {
                    console.error(`Error saving ${collectionName}:`, error);
                    alert(`×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×: ${error.message}`);
                } finally {
                    hideLoading();
                    saveBtn.disabled = false;
                }
            });
        };
        
        // --- SITES ---
        const openSiteModal = (site = null) => {
            const form = document.getElementById('site-form');
            form.reset();
            document.getElementById('site-id').value = site ? site.id : '';
            document.getElementById('site-modal-title').textContent = site ? '×¢×¨×•×š ××ª×¨' : '×”×•×¡×£ ××ª×¨ ×—×“×©';
            if(site) { document.getElementById('site-name').value = site.name; document.getElementById('site-details').value = site.details; }
            openModal(siteModal);
        };
        const siteForm = document.getElementById('site-form');
        document.getElementById('add-site-btn').addEventListener('click', () => openSiteModal());
        siteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveBtn = siteForm.querySelector('button[type="submit"]');
            saveBtn.disabled = true; showLoading('×©×•××¨ ××ª×¨...');
            try {
                const data = { name: document.getElementById('site-name').value, details: document.getElementById('site-details').value };
                const id = document.getElementById('site-id').value;
                if (id) await updateDoc(doc(db, 'sites', id), data);
                else await addDoc(collection(db, 'sites'), data);
                closeModal(siteModal);
            } catch (err) { alert('×©×’×™××” ×‘×©××™×¨×ª ×”××ª×¨.'); console.error(err); }
            finally { hideLoading(); saveBtn.disabled = false; }
        });


        // --- MANAGERS ---
        const openManagerModal = (manager = null) => {
            const form = document.getElementById('manager-form');
            form.reset();
            document.getElementById('manager-image-status').innerHTML = '';
            document.getElementById('manager-upload-progress').classList.add('hidden');
            document.getElementById('save-manager-btn').disabled = false; document.getElementById('save-manager-btn').textContent = "×©××•×¨ ×× ×”×œ";
            document.getElementById('manager-id').value = manager ? manager.id : '';
            document.getElementById('manager-modal-title').textContent = manager ? '×¢×¨×•×š ×× ×”×œ' : '×”×•×¡×£ ×× ×”×œ ×—×“×©';
            if (manager) {
                document.getElementById('manager-name').value = manager.name; document.getElementById('manager-phone').value = manager.phone;
                document.getElementById('manager-id-number').value = manager.idNumber; document.getElementById('manager-responsibility').value = manager.responsibility;
                document.getElementById('manager-image-url').value = manager.imageUrl || '';
                if(manager.imageUrl) document.getElementById('manager-image-status').innerHTML = `<a href="${manager.imageUrl}" target="_blank" style="color: var(--primary-gold);">×ª××•× ×” ×§×™×™××ª</a>`;
                const siteIds = manager.sites.map(s => s.id);
                Array.from(document.getElementById('manager-sites').options).forEach(opt => opt.selected = siteIds.includes(opt.value));
            }
            openModal(managerModal);
        };
        setupForm('manager-form', managerModal, 'add-manager-btn', 'managers', () => {
            const sites = Array.from(document.getElementById('manager-sites').selectedOptions).map(opt => ({ id: opt.value, name: opt.textContent }));
            const data = {
                name: document.getElementById('manager-name').value, phone: document.getElementById('manager-phone').value,
                idNumber: document.getElementById('manager-id-number').value, responsibility: document.getElementById('manager-responsibility').value,
                sites, imageUrl: document.getElementById('manager-image-url').value
            };
            const id = document.getElementById('manager-id').value;
            return { data, id, needsImage: true };
        }, () => openManagerModal());

        // --- PROFILES ---
        const openProfileModal = (profile = null) => {
            const form = document.getElementById('profile-form');
            form.reset();
            document.getElementById('profile-image-status').innerHTML = '';
            document.getElementById('profile-upload-progress').classList.add('hidden');
            document.getElementById('save-profile-btn').disabled = false; document.getElementById('save-profile-btn').textContent = "×©××•×¨ ×¤×¨×•×¤×™×œ";
            document.getElementById('profile-id').value = profile ? profile.id : '';
            document.getElementById('profile-modal-title').textContent = profile ? '×¢×¨×•×š ×¤×¨×•×¤×™×œ' : '×”×•×¡×£ ×¤×¨×•×¤×™×œ ×—×“×©';
            if (profile) {
                 document.getElementById('profile-name').value = profile.name; document.getElementById('profile-phone').value = profile.phone;
                 document.getElementById('profile-id-number').value = profile.idNumber; document.getElementById('profile-role').value = profile.role;
                 document.getElementById('profile-active').checked = profile.isActive; document.getElementById('profile-image-url').value = profile.imageUrl || '';
                 if(profile.imageUrl) document.getElementById('profile-image-status').innerHTML = `<a href="${profile.imageUrl}" target="_blank" style="color: var(--primary-gold);">×ª××•× ×” ×§×™×™××ª</a>`;
                 document.getElementById('profile-manager').value = profile.manager.id;
                 const siteIds = profile.sites.map(s => s.id);
                 Array.from(document.getElementById('profile-sites').options).forEach(opt => opt.selected = siteIds.includes(opt.value));
            }
            openModal(profileModal);
        };
        setupForm('profile-form', profileModal, 'add-profile-btn', 'profiles', () => {
            const managerSelect = document.getElementById('profile-manager');
            const manager = { id: managerSelect.value, name: managerSelect.options[managerSelect.selectedIndex].text };
            const sites = Array.from(document.getElementById('profile-sites').selectedOptions).map(opt => ({ id: opt.value, name: opt.textContent }));
            const data = {
                name: document.getElementById('profile-name').value, phone: document.getElementById('profile-phone').value,
                idNumber: document.getElementById('profile-id-number').value, role: document.getElementById('profile-role').value,
                isActive: document.getElementById('profile-active').checked, manager, sites, 
                imageUrl: document.getElementById('profile-image-url').value
            };
            const id = document.getElementById('profile-id').value;
            return { data, id, needsImage: true };
        }, () => openProfileModal());

        // --- RENDER & DISPLAY ---
        const renderSites = (sites) => {
            document.getElementById('sites-list').innerHTML = sites.length === 0 ? '<p class="text-gray-400">×œ× × ××¦××• ××ª×¨×™×.</p>' : sites.map(site => `
                <div class="item-card bg-gray-800 p-2 rounded-md flex justify-between items-center text-sm" data-type="site" data-id="${site.id}"><div><p class="font-semibold">${site.name}</p></div><div class="flex gap-2"><button class="edit-btn" data-type="site" data-id="${site.id}">âœï¸</button><button class="delete-btn" data-type="site" data-id="${site.id}">ğŸ—‘ï¸</button></div></div>`).join('');
            const optionsHtml = sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.getElementById('manager-sites').innerHTML = optionsHtml;
            document.getElementById('profile-sites').innerHTML = optionsHtml;
        };
        const renderManagers = (managers) => {
            document.getElementById('managers-list').innerHTML = managers.length === 0 ? '<p class="text-gray-400">×œ× × ××¦××• ×× ×”×œ×™×.</p>' : managers.map(m => `
                <div class="item-card bg-gray-800 p-2 rounded-md flex justify-between items-center text-sm" data-type="manager" data-id="${m.id}"><div class="flex items-center gap-2"><img src="${m.imageUrl || 'https://placehold.co/32x32'}" class="w-8 h-8 rounded-full object-cover"><p>${m.name}</p></div><div class="flex gap-2"><button class="edit-btn" data-type="manager" data-id="${m.id}">âœï¸</button><button class="delete-btn" data-type="manager" data-id="${m.id}">ğŸ—‘ï¸</button></div></div>`).join('');
            document.getElementById('profile-manager').innerHTML = `<option value="" disabled selected>×‘×—×¨ ×× ×”×œ...</option>` + managers.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        };
        const renderProfiles = (profiles) => {
            document.getElementById('profiles-list').innerHTML = profiles.length === 0 ? '<p class="text-gray-400 text-center col-span-full">×œ× × ××¦××• ×¤×¨×•×¤×™×œ×™×.</p>' : profiles.map(p => `
                <div class="item-card bg-gray-800 p-4 rounded-lg flex items-start gap-4" data-type="profile" data-id="${p.id}"><img src="${p.imageUrl || 'https://placehold.co/64x64'}" alt="Profile" class="w-16 h-16 rounded-full object-cover"><div class="flex-grow"><h4 class="font-bold text-lg">${p.name}</h4><p class="text-sm" style="color:var(--primary-gold);">${p.role}</p><p class="text-xs text-gray-400 mt-1">××—×¨××™: ${p.manager.name}</p><div class="mt-2">${p.isActive ? '<span class="text-xs text-green-400 bg-green-900 px-2 py-1 rounded-full">×¤×¢×™×œ</span>' : '<span class="text-xs text-red-400 bg-red-900 px-2 py-1 rounded-full">×œ× ×¤×¢×™×œ</span>'}</div></div><div class="flex flex-col gap-2"><button class="edit-btn" data-type="profile" data-id="${p.id}">âœï¸</button><button class="delete-btn" data-type="profile" data-id="${p.id}">ğŸ—‘ï¸</button></div></div>`).join('');
        };
        const showDetails = (type, data) => {
            const titleEl = document.getElementById('details-modal-title'), contentEl = document.getElementById('details-modal-content'), qrEl = document.getElementById('details-modal-qr-code');
            contentEl.innerHTML = ''; qrEl.innerHTML = ''; let contentHTML = '';
            if (type === 'site') {
                titleEl.textContent = '×¤×¨×˜×™ ××ª×¨'; contentHTML = `<p><strong>×©×:</strong> ${data.name}</p><p><strong>×¤×¨×˜×™×:</strong> ${data.details || '××™×Ÿ'}</p>`;
            } else {
                const sitesHtml = data.sites.map(s => `<span class="bg-gray-700 text-gray-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${s.name}</span>`).join(' ');
                contentHTML = `<div class="flex items-center gap-4 mb-4"><img src="${data.imageUrl}" class="w-20 h-20 rounded-full object-cover border-2" style="border-color: var(--primary-gold);"><h4 class="text-xl font-bold">${data.name}</h4></div><p><strong>×ª.×–.:</strong> ${data.idNumber}</p><p><strong>×˜×œ×¤×•×Ÿ:</strong> ${data.phone}</p>`;
                if (type === 'manager') { titleEl.textContent = '×¤×¨×˜×™ ×× ×”×œ'; contentHTML += `<p><strong>××—×¨×™×•×ª:</strong> ${data.responsibility}</p>`; } 
                else { titleEl.textContent = '×¤×¨×˜×™ ×¤×¨×•×¤×™×œ'; contentHTML += `<p><strong>×ª×¤×§×™×“:</strong> ${data.role}</p><p><strong>×× ×”×œ:</strong> ${data.manager.name}</p><p><strong>×¡×˜×˜×•×¡:</strong> ${data.isActive ? '<span class="text-green-400">×¤×¢×™×œ</span>' : '<span class="text-red-400">×œ× ×¤×¢×™×œ</span>'}</p>`; }
                contentHTML += `<div class="mt-2"><strong class="block mb-1">××ª×¨×™×:</strong> ${sitesHtml}</div>`;
                new QRCode(qrEl, { text: data.id, width: 128, height: 128, colorDark: "#E0E0E0", colorLight: "#1E1E1E" });
            }
            contentEl.innerHTML = contentHTML; openModal(detailsModal);
        };

        // EVENT DELEGATION
        document.body.addEventListener('click', async (e) => {
            const button = e.target.closest('.edit-btn, .delete-btn');
            if (button) {
                e.stopPropagation();
                const id = button.dataset.id; const type = button.dataset.type;
                if (button.classList.contains('edit-btn')) {
                    const docSnap = await getDoc(doc(db, `${type}s`, id));
                    if (!docSnap.exists()) return;
                    const data = { id: docSnap.id, ...docSnap.data() };
                    if (type === 'site') openSiteModal(data); else if (type === 'manager') openManagerModal(data); else if (type === 'profile') openProfileModal(data);
                } else if (button.classList.contains('delete-btn')) { if (confirm(`×”×× ×œ××—×•×§ ××ª ×”×¤×¨×™×˜?`)) await deleteDoc(doc(db, `${type}s`, id)); }
                return;
            }
            const card = e.target.closest('.item-card');
            if (card) {
                const id = card.dataset.id; const type = card.dataset.type;
                const docSnap = await getDoc(doc(db, `${type}s`, id));
                if (docSnap.exists()) showDetails(type, { id, ...docSnap.data() });
            }
        });
        
        // SCANNER
        document.getElementById('scan-qr-btn').addEventListener('click', () => {
            openModal(document.getElementById('scanner-modal'));
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (decodedText) => {
                await html5QrcodeScanner.stop(); closeModal(document.getElementById('scanner-modal')); showLoading();
                const profileSnap = await getDoc(doc(db, "profiles", decodedText));
                if (profileSnap.exists()) showDetails('profile', {id: profileSnap.id, ...profileSnap.data()});
                else {
                    const managerSnap = await getDoc(doc(db, "managers", decodedText));
                    if(managerSnap.exists()) showDetails('manager', {id: managerSnap.id, ...managerSnap.data()});
                    else alert("×œ× × ××¦× ×¤×¨×•×¤×™×œ ××• ×× ×”×œ ×ª×•××.");
                }
                hideLoading();
            }, (error) => {});
        });
        document.getElementById('cancel-scanner-modal').addEventListener('click', () => { if (html5QrcodeScanner && html5QrcodeScanner.isScanning) html5QrcodeScanner.stop(); closeModal(document.getElementById('scanner-modal')); });

        // REALTIME LISTENERS
        onSnapshot(collection(db, "sites"), (snapshot) => renderSites(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        onSnapshot(collection(db, "managers"), (snapshot) => renderManagers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        onSnapshot(collection(db, "profiles"), (snapshot) => renderProfiles(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));

        window.onload = () => hideLoading();
    </script>
</body>
</html>


