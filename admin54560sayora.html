<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   
   <!-- הדבק בתוך <head> -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#121212">

<!-- תמיכה ב-iOS למסך מלא ואייקון -->
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
   
   
                <title>Sayora Festival - QR Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-surface: #1E1E1E;
            --primary-gold: #c09a3e;
            --primary-gold-hover: #d4af37;
            --primary-gold-glow: rgba(192, 154, 62, 0.4);
            --text-light: #E0E0E0;
            --border-color: #444444;
        }
        body {
            font-family: 'Assistant', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            overflow: hidden;
        }
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .main-content {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 1s ease-out forwards;
        }
        .btn-primary { background-color: var(--primary-gold); color: var(--bg-dark); transition: background-color 0.3s; }
        .btn-primary:hover { background-color: var(--primary-gold-hover); }
        .scan-button {
            box-shadow: 0 0 15px var(--primary-gold-glow), 0 0 25px var(--primary-gold-glow);
            animation: pulse 2.5s infinite;
        }
        .modal-backdrop { background-color: rgba(0,0,0,0.8); }
        .modal-content {
            background-color: var(--bg-surface);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: scaleIn 0.3s ease-out;
        }
        .profile-card-image {
             border: 3px solid var(--primary-gold);
             box-shadow: 0 0 10px var(--primary-gold-glow);
        }
        .form-input { background-color: #2a2a2a; border: 1px solid var(--border-color); color: var(--text-light); border-radius: 0.5rem; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-input:focus { outline: none; border-color: var(--primary-gold); box-shadow: 0 0 0 2px var(--primary-gold-glow); }

        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse {
            0% { box-shadow: 0 0 15px var(--primary-gold-glow), 0 0 25px var(--primary-gold-glow); }
            50% { box-shadow: 0 0 25px var(--primary-gold-glow), 0 0 40px var(--primary-gold-glow); }
            100% { box-shadow: 0 0 15px var(--primary-gold-glow), 0 0 25px var(--primary-gold-glow); }
        }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="antialiased">

    <canvas id="particle-canvas"></canvas>

    <!-- START: Login Modal -->
    <div id="login-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
        <div class="modal-content p-8 rounded-xl w-full max-w-sm text-center">
            <img src="https://i.imgur.com/fYUvEiv.png" alt="Sayora Festival Logo" class="w-24 h-24 mx-auto rounded-full shadow-lg mb-4" style="box-shadow: 0 0 15px var(--primary-gold-glow);">
            <h2 class="text-2xl font-bold mb-2">כניסת סדרנים</h2>
            <p class="text-gray-400 mb-6">יש להזין תעודת זהות לצורך אימות.</p>
            <form id="login-form">
                <input type="password" id="steward-id-input" class="form-input w-full p-3 text-center text-lg tracking-widest" placeholder="תעודת זהות" required>
                <p id="login-error" class="text-red-500 text-sm mt-2 h-5"></p>
                <button type="submit" class="w-full mt-4 btn-primary font-bold text-lg py-3 px-8 rounded-lg transition-transform duration-300 hover:scale-105">
                    התחבר
                </button>
            </form>
        </div>
    </div>
    <!-- END: Login Modal -->
    
    <!-- This container will be hidden until login is successful -->
    <div id="main-container" class="hidden">
        <div class="min-h-screen flex flex-col items-center justify-center text-center p-4">
            <main class="main-content" style="animation-delay: 0.2s;">
                <img src="https://i.imgur.com/fYUvEiv.png" alt="Sayora Festival Logo" class="w-32 h-32 md:w-40 md:h-40 mx-auto rounded-full shadow-lg mb-6" style="box-shadow: 0 0 20px var(--primary-gold-glow);">
                <h1 class="text-4xl md:text-6xl font-extrabold text-white tracking-wider">SAYORA<span style="color: var(--primary-gold);"> FESTIVAL</span></h1>
                <p class="text-lg md:text-xl text-gray-300 mt-2 mb-10">מערכת בקרת כניסות</p>
                <button id="scan-qr-btn" class="scan-button bg-primary-gold text-bg-dark font-bold text-xl py-4 px-10 rounded-full transition-transform duration-300 hover:scale-105">
                    סרוק ברקוד
                </button>
            </main>
        </div>
    </div>

    <div id="scanner-modal" class="fixed inset-0 bg-black bg-opacity-80 items-center justify-center z-40 hidden p-4">
        <div class="modal-content p-6 rounded-lg w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-4 text-center">מקם את הברקוד מול המצלמה</h3>
            <div id="reader" class="w-full bg-gray-800 rounded-lg overflow-hidden border-2" style="border-color: var(--primary-gold)"></div>
            <div class="text-center mt-4">
                <button id="cancel-scanner-modal" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-full">ביטול</button>
            </div>
        </div>
    </div>
    
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-80 items-center justify-center z-50 hidden p-4">
        <div id="profile-card-content" class="modal-content p-8 rounded-xl w-full max-w-md text-center">
            </div>
    </div>
    
    <div id="feedback-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex-col gap-4 justify-center items-center z-50 hidden">
        <div id="feedback-spinner" class="animate-spin rounded-full h-24 w-24 border-t-2 border-b-2" style="border-color: var(--primary-gold);"></div>
        <p id="feedback-text" class="text-lg mt-4"></p>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyAUdX5OhKdNVvXTwVMF6zul6zGhldqx_s0", authDomain: "sayora-786c4.firebaseapp.com", projectId: "sayora-786c4", storageBucket: "sayora-786c4.firebasestorage.app", messagingSenderId: "353491525675", appId: "1:353491525675:web:0c59e5183e112e9bf84a6e" };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Login elements
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const stewardIdInput = document.getElementById('steward-id-input');
        const loginError = document.getElementById('login-error');
        const mainContainer = document.getElementById('main-container');

        // Main app elements
        const scanBtn = document.getElementById('scan-qr-btn');
        const scannerModal = document.getElementById('scanner-modal');
        const cancelScannerBtn = document.getElementById('cancel-scanner-modal');
        const detailsModal = document.getElementById('details-modal');
        const profileCardContent = document.getElementById('profile-card-content');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const feedbackText = document.getElementById('feedback-text');
        const feedbackSpinner = document.getElementById('feedback-spinner');
        let html5QrcodeScanner;

        const showFeedback = (text, showSpinner = true) => {
            feedbackText.textContent = text;
            feedbackSpinner.style.display = showSpinner ? 'block' : 'none';
            feedbackOverlay.style.display = 'flex';
        };
        const hideFeedback = () => {
            feedbackOverlay.style.display = 'none';
        };
        
        // --- Login Logic ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const stewardId = stewardIdInput.value.trim();
            loginError.textContent = '';
            if (!stewardId) {
                loginError.textContent = 'יש להזין תעודת זהות.';
                return;
            }

            showFeedback('מאמת הרשאות...');

            try {
                const profilesRef = collection(db, "profiles");
                const q = query(profilesRef, where("isSteward", "==", true), where("idNumber", "==", stewardId));
                
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Successful login
                    loginModal.style.display = 'none';
                    mainContainer.classList.remove('hidden');
                } else {
                    // Failed login
                    loginError.textContent = 'ת.ז. שגויה או שאין הרשאות סדרן.';
                }
            } catch (error) {
                console.error("Login error:", error);
                loginError.textContent = 'שגיאה באימות מול השרת.';
            } finally {
                hideFeedback();
            }
        });


        // --- Scanner Logic ---
        scanBtn.addEventListener('click', () => {
            scannerModal.style.display = 'flex';
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                (error) => { /* Ignore scan failure */ }
            ).catch(err => console.error("Scanner failed to start.", err));
        });

        const stopScanner = () => {
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                html5QrcodeScanner.stop().catch(err => console.error("Failed to stop scanner.", err));
            }
            scannerModal.style.display = 'none';
        };

        cancelScannerBtn.addEventListener('click', stopScanner);

        const onScanSuccess = async (decodedText, decodedResult) => {
            stopScanner();
            showFeedback('מאמת נתונים...');
            
            try {
                let docSnap = await getDoc(doc(db, "profiles", decodedText));
                let type = 'profile';
                if (!docSnap.exists()) {
                    docSnap = await getDoc(doc(db, "managers", decodedText));
                    type = 'manager';
                }

                if (docSnap.exists()) {
                    displayProfileDetails(docSnap.data(), type);
                    detailsModal.style.display = 'flex';
                    hideFeedback();
                } else {
                    showFeedback('הברקוד אינו תקין', false);
                    setTimeout(hideFeedback, 2500);
                }
            } catch (error) {
                console.error("Error fetching document:", error);
                showFeedback('שגיאה בגישה לשרת', false);
                setTimeout(hideFeedback, 2500);
            }
        };

        const displayProfileDetails = (data, type) => {
            const statusBadge = data.isActive 
                ? `<span class="px-3 py-1 text-sm font-semibold text-green-200 bg-green-800 rounded-full">פעיל</span>` 
                : `<span class="px-3 py-1 text-sm font-semibold text-red-200 bg-red-800 rounded-full">לא פעיל</span>`;

            const sitesHtml = data.sites.map(site => `<span class="bg-gray-700 text-xs font-medium mr-2 mb-2 px-2.5 py-1 rounded">${site.name}</span>`).join('');

            let specificInfo = '';
            if (type === 'profile') {
                specificInfo = `
                    <p class="text-lg" style="color: var(--primary-gold);">${data.role}</p>
                    <p class="text-sm text-gray-400 mt-1">מנהל אחראי: ${data.manager.name}</p>
                `;
            } else { // manager
                specificInfo = `<p class="text-lg" style="color: var(--primary-gold);">מנהל</p>`;
            }

            profileCardContent.innerHTML = `
                <img src="${data.imageUrl}" alt="Profile Picture" class="w-32 h-32 rounded-full mx-auto object-cover profile-card-image mb-4">
                <h2 class="text-3xl font-bold">${data.name}</h2>
                ${specificInfo}
                <div class="my-4">${type === 'profile' ? statusBadge : ''}</div>
                <div class="text-left space-y-3 my-6 border-t border-b py-4" style="border-color: var(--border-color)">
                    <p class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3" style="color: var(--primary-gold);" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4a1 1 0 011-1h1.586l.707-.707a1 1 0 011.414 0L10 3.586l1.293-1.293a1 1 0 011.414 0L13.414 3H15a1 1 0 110 2h-1v1.5a1 1 0 11-2 0V5h-1a1 1 0 110-2h.172l.707-.707-1.414-1.414-1-1-1.414 1.414-.707.707H5a1 1 0 01-1-1zm12 5a1 1 0 01-1 1h-1v1.5a1 1 0 11-2 0V10h-1a1 1 0 110-2h.172l.707-.707-1.414-1.414-1-1-1.414 1.414-.707.707H9a1 1 0 110-2h1.586l.707-.707a1 1 0 011.414 0L14 7.586l1.293-1.293a1 1 0 011.414 0L17.414 7H19a1 1 0 110 2h-1.586l-.707.707a1 1 0 01-1.414 0L14 8.414 12.707 9.707a1 1 0 01-1.414 0L10.586 9H10a1 1 0 010-2h.586l.707.707 1.414-1.414 1-1 1.414 1.414.707.707H16a1 1 0 011 1z" clip-rule="evenodd" /></svg><strong>ת.ז.:</strong> <span class="mr-2">${data.idNumber}</span></p>
                    <p class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3" style="color: var(--primary-gold);" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" /></svg><strong>טלפון:</strong> <span class="mr-2">${data.phone}</span></p>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-left mb-2">אזורי גישה מורשים:</h4>
                    <div class="flex flex-wrap justify-start">${sitesHtml}</div>
                </div>
                <button id="close-details-modal" class="mt-8 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-8 rounded-full">סגור</button>
            `;
            document.getElementById('close-details-modal').addEventListener('click', () => {
                detailsModal.style.display = 'none';
            });
        };

        // --- Particle background animation ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray;

        class Particle {
            constructor(x, y, directionX, directionY, size, color) { this.x = x; this.y = y; this.directionX = directionX; this.directionY = directionY; this.size = size; this.color = color; }
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); ctx.fillStyle = this.color; ctx.fill(); }
            update() { if (this.x > canvas.width || this.x < 0) this.directionX = -this.directionX; if (this.y > canvas.height || this.y < 0) this.directionY = -this.directionY; this.x += this.directionX; this.y += this.directionY; this.draw(); }
        }
        function initParticles() {
            particlesArray = [];
            let numberOfParticles = (canvas.height * canvas.width) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 2) + 0.5;
                let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                let directionX = (Math.random() * .4) - .2;
                let directionY = (Math.random() * .4) - .2;
                particlesArray.push(new Particle(x, y, directionX, directionY, 'rgba(192, 154, 62, 0.4)'));
            }
        }
        function animateParticles() { requestAnimationFrame(animateParticles); ctx.clearRect(0,0,innerWidth, innerHeight); for (let i = 0; i < particlesArray.length; i++) particlesArray[i].update(); }
        
        // Initialize particles on load
        initParticles();
        animateParticles();
        window.addEventListener('resize', () => { canvas.width = innerWidth; canvas.height = innerHeight; initParticles(); });
    </script>
</body>
</html>

    
     <title>Sayora Festival - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-surface: #1E1E1E;
            --primary-gold: #c09a3e;
            --primary-gold-hover: #d4af37;
            --text-light: #E0E0E0;
            --border-color: #444444;
        }
        body { font-family: 'Assistant', sans-serif; background-color: var(--bg-dark); color: var(--text-light); }
        .modal-backdrop { background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: var(--bg-surface); border: 1px solid var(--border-color); max-height: 90vh; overflow-y: auto; }
        .form-input, .form-select, .form-textarea { background-color: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-light); border-radius: 0.5rem; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-gold); box-shadow: 0 0 0 2px rgba(192, 154, 62, 0.4); }
        .btn { border-radius: 0.5rem; font-weight: bold; padding: 0.6rem 1.2rem; transition: all 0.3s; cursor: pointer; }
        .btn-primary { background-color: var(--primary-gold); color: var(--bg-dark); }
        .btn-primary:hover { background-color: var(--primary-gold-hover); transform: translateY(-2px); }
        .btn-primary:disabled { background-color: #555; color: #999; cursor: not-allowed; transform: none; }
        .btn-secondary { background-color: #333; color: var(--text-light); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: #444; }
        .toggle-bg { transition: background-color 0.3s; }
        .toggle-checkbox:checked + .toggle-bg:after { transform: translateX(100%); }
        .toggle-checkbox:checked + .toggle-bg { background: var(--primary-gold); }
        .toggle-checkbox { width: 1.5rem; height: 1.5rem; }
        .toggle-label { width: 3rem; height: 1.5rem; }
        .toggle-label:after { content: ''; position: absolute; top: 2px; left: 2px; background: white; border-radius: 50%; transition: 0.3s; width: 20px; height: 20px; }
        .item-card { cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .item-card:hover { background-color: #2a2a2a; transform: translateY(-3px); }
        .progress-bar-bg { background-color: #333; }
        .progress-bar-fg { background-color: var(--primary-gold); transition: width 0.2s ease-in-out; }
        .image-uploader { background-color: #2a2a2a; border: 2px dashed var(--border-color); cursor: pointer; }
        .image-uploader:hover { border-color: var(--primary-gold); }
        .image-preview { width: 64px; height: 64px; object-fit: cover; border-radius: 0.375rem; }
        .card-btn { background: none; border: none; padding: 4px; border-radius: 50%; transition: background-color 0.2s; }
        .card-btn:hover { background-color: rgba(255,255,255,0.1); }
        
        /* Print styles for the badge */
        @page {
            size: auto;
            margin: 0;
        }
        @media print {
            html, body {
                width: 210mm;
                height: 297mm;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden;
            }
            body * { visibility: hidden; }
            #badge-design-area-wrapper, #badge-design-area-wrapper * { visibility: visible; }
            #badge-design-area-wrapper {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
            }
            #badge-design-area {
                width: 5.4cm;
                height: 8.6cm;
            }
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex-col gap-4 justify-center items-center z-[70]">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2" style="border-color: var(--primary-gold);"></div>
        <p id="loading-text" class="text-lg">טוען...</p>
    </div>
    
    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4">
        <div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <div class="flex flex-col items-center gap-3 mb-6">
                <img src="https://i.imgur.com/fYUvEiv.png" alt="Sayora Festival Logo" class="w-20 h-20 rounded-full shadow-lg" style="box-shadow: 0 0 10px var(--primary-gold);">
                <h2 class="text-2xl font-bold text-white tracking-wider">SAYORA<span style="color: var(--primary-gold);"> FESTIVAL</span></h2>
                <p class="text-gray-400">התחברות למערכת הניהול</p>
            </div>
            <form id="auth-form">
                <div class="mb-4">
                    <label for="auth-email" class="block mb-2">אימייל</label>
                    <input type="email" id="auth-email" class="w-full p-2 form-input" required>
                </div>
                <div class="mb-6">
                    <label for="auth-password" class="block mb-2">סיסמה</label>
                    <input type="password" id="auth-password" class="w-full p-2 form-input" required>
                </div>
                <p id="auth-error" class="text-red-500 text-center mb-4 h-4"></p>
                <button type="submit" class="btn btn-primary w-full">התחבר</button>
            </form>
        </div>
    </div>
    
    <div id="main-content" class="container mx-auto p-4 md:p-8" style="display: none;">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b-2 pb-6" style="border-color: var(--primary-gold);">
            <div class="flex items-center gap-4">
                <img src="https://i.imgur.com/fYUvEiv.png" alt="Sayora Festival Logo" class="w-20 h-20 md:w-24 md:h-24 rounded-full shadow-lg" style="box-shadow: 0 0 15px var(--primary-gold);">
                <h1 class="text-3xl md:text-5xl font-bold text-white tracking-wider">SAYORA<span style="color: var(--primary-gold);"> FESTIVAL</span></h1>
            </div>
            <div class="flex flex-col items-center gap-4 mt-6 md:mt-0">
                <div id="user-controls" class="hidden items-center gap-4">
                    <span id="welcome-message" class="text-lg"></span>
                    <button id="logout-btn" class="btn btn-secondary text-sm">התנתק</button>
                </div>
                <div class="flex items-center gap-4 mt-2">
                     <a href="index.html" class="btn btn-secondary text-lg">מעבר לדף הבית</a>
                     <button id="add-user-btn" class="btn btn-secondary text-lg">הוסף משתמש</button>
                     <button id="scan-qr-btn" class="btn btn-primary text-lg">סרוק ברקוד</button>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-transparent p-6 rounded-lg shadow-lg border border-gray-800">
                    <h2 class="text-2xl font-semibold mb-4" style="color: var(--primary-gold);">ניהול אתרים</h2>
                    <button id="add-site-btn" class="w-full btn btn-primary mb-4">הוסף אתר חדש</button>
                    <div id="sites-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
                <div class="bg-transparent p-6 rounded-lg shadow-lg border border-gray-800">
                    <h2 class="text-2xl font-semibold mb-4" style="color: var(--primary-gold);">ניהול מנהלים</h2>
                    <button id="add-manager-btn" class="w-full btn btn-primary mb-4">הוסף מנהל חדש</button>
                    <div id="managers-list" class="space-y-3 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            <div class="bg-transparent p-6 rounded-lg shadow-lg lg:col-span-2 border border-gray-800">
                <h2 class="text-2xl font-semibold mb-4" style="color: var(--primary-gold);">ניהול פרופילים</h2>
                <button id="add-profile-btn" class="w-full btn btn-primary mb-4">הוסף פרופיל חדש</button>
                 <div id="profiles-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[34rem] overflow-y-auto p-2"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="add-user-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4">
        <div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6">הוספת משתמש חדש</h3>
            <form id="add-user-form">
                <div class="mb-4">
                    <label for="new-user-name" class="block mb-2">שם מלא <span class="text-red-500">*</span></label>
                    <input type="text" id="new-user-name" class="w-full p-2 form-input" required>
                </div>
                <div class="mb-4">
                    <label for="new-user-email" class="block mb-2">אימייל <span class="text-red-500">*</span></label>
                    <input type="email" id="new-user-email" class="w-full p-2 form-input" required>
                </div>
                <div class="mb-6">
                    <label for="new-user-password" class="block mb-2">סיסמה <span class="text-red-500">*</span></label>
                    <input type="password" id="new-user-password" class="w-full p-2 form-input" required pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$">
                    <p class="text-xs text-gray-400 mt-1">חייב להכיל 8+ תווים, אותיות, מספר וסימן מיוחד (@$!%*#?&).</p>
                </div>
                <p id="add-user-error" class="text-red-500 text-center mb-4 h-4"></p>
                <div class="flex justify-end gap-4">
                    <button type="button" class="btn btn-secondary cancel-modal-btn">ביטול</button>
                    <button type="submit" class="btn btn-primary">הוסף משתמש</button>
                </div>
            </form>
        </div>
    </div>
    <div id="site-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-md"><h3 id="site-modal-title" class="text-2xl font-bold mb-6">הוסף אתר חדש</h3><form id="site-form"><input type="hidden" id="site-id"><div class="mb-4"><label for="site-name" class="block mb-2">שם האתר <span class="text-red-500">*</span></label><input type="text" id="site-name" class="w-full p-2 form-input" required></div><div class="mb-6"><label for="site-details" class="block mb-2">פירוט</label><textarea id="site-details" class="w-full p-2 form-textarea" rows="3"></textarea></div><div class="flex justify-end gap-4"><button type="button" class="btn btn-secondary cancel-modal-btn">ביטול</button><button type="submit" class="btn btn-primary">שמור</button></div></form></div></div>
    <div id="manager-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-lg"><h3 id="manager-modal-title" class="text-2xl font-bold mb-6">הוסף מנהל חדש</h3><form id="manager-form" novalidate><input type="hidden" id="manager-id"><input type="hidden" id="manager-image-url"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="manager-name" class="block mb-2">שם מלא <span class="text-red-500">*</span></label><input type="text" id="manager-name" class="w-full p-2 form-input" required></div><div><label for="manager-phone" class="block mb-2">מספר טלפון <span class="text-red-500">*</span></label><input type="tel" id="manager-phone" class="w-full p-2 form-input" required></div><div><label for="manager-id-number" class="block mb-2">תעודת זהות <span class="text-red-500">*</span></label><input type="text" id="manager-id-number" class="w-full p-2 form-input" required></div><div><div class="flex justify-between items-center mb-2"><label for="manager-sites">אתרים מורשים <span class="text-red-500">*</span></label><button type="button" class="text-xs btn-secondary py-1 px-2" id="select-all-manager-sites-btn">בחר הכל</button></div><select id="manager-sites" class="w-full p-2 form-select" multiple required></select></div><div class="md:col-span-2"><label for="manager-responsibility" class="block mb-2">אחריות <span class="text-red-500">*</span></label><textarea id="manager-responsibility" class="w-full p-2 form-textarea" rows="3" required></textarea></div><div class="md:col-span-2"><label class="block mb-2">תמונת פרופיל <span class="text-red-500">*</span></label><label for="manager-image-input" class="image-uploader p-4 rounded-lg flex items-center gap-4 w-full"><img id="manager-image-preview" src="https://placehold.co/64x64/2a2a2a/444444?text=בחר" alt="Preview" class="image-preview"><div class="flex-1"><p id="manager-image-filename" class="text-sm text-gray-400">יש לבחור תמונה</p><div id="manager-image-status" class="text-sm mt-1"></div></div></label><input type="file" id="manager-image-input" class="hidden" accept="image/*"><div id="manager-upload-progress" class="hidden mt-2"><div class="progress-bar-bg w-full rounded-full h-2.5"><div id="manager-progress-bar" class="progress-bar-fg h-2.5 rounded-full" style="width: 0%"></div></div><div id="manager-upload-status" class="text-sm text-center mt-1"></div></div></div></div><div class="flex justify-end gap-4 mt-6"><button type="button" class="btn btn-secondary cancel-modal-btn">ביטול</button><button type="submit" id="save-manager-btn" class="btn btn-primary">שמור מנהל</button></div></form></div></div>
    <div id="profile-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-lg"><h3 id="profile-modal-title" class="text-2xl font-bold mb-6">הוסף פרופיל חדש</h3><form id="profile-form" novalidate><input type="hidden" id="profile-id"><input type="hidden" id="profile-image-url"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="profile-name" class="block mb-2">שם מלא <span class="text-red-500">*</span></label><input type="text" id="profile-name" class="w-full p-2 form-input" required></div><div><label for="profile-phone" class="block mb-2">מספר טלפון <span class="text-red-500">*</span></label><input type="tel" id="profile-phone" class="w-full p-2 form-input" required></div><div><label for="profile-id-number" class="block mb-2">תעודת זהות <span class="text-red-500">*</span></label><input type="text" id="profile-id-number" class="w-full p-2 form-input" required></div><div><label for="profile-role" class="block mb-2">תפקיד <span class="text-red-500">*</span></label><input type="text" id="profile-role" class="w-full p-2 form-input" required></div><div><label for="profile-manager" class="block mb-2">מנהל אחראי <span class="text-red-500">*</span></label><select id="profile-manager" class="w-full p-2 form-select" required></select></div><div><div class="flex justify-between items-center mb-2"><label for="profile-sites" class="block">גישה לאתרים <span class="text-red-500">*</span></label><button type="button" class="text-xs btn-secondary py-1 px-2" id="select-all-profile-sites-btn">בחר הכל</button></div><select id="profile-sites" class="w-full p-2 form-select" multiple required></select></div><div class="md:col-span-2"><label class="block mb-2">תמונת פרופיל <span class="text-red-500">*</span></label><label for="profile-image-input" class="image-uploader p-4 rounded-lg flex items-center gap-4 w-full"><img id="profile-image-preview" src="https://placehold.co/64x64/2a2a2a/444444?text=בחר" alt="Preview" class="image-preview"><div class="flex-1"><p id="profile-image-filename" class="text-sm text-gray-400">יש לבחור תמונה</p><div id="profile-image-status" class="text-sm mt-1"></div></div></label><input type="file" id="profile-image-input" class="hidden" accept="image/*"><div id="profile-upload-progress" class="hidden mt-2"><div class="progress-bar-bg w-full rounded-full h-2.5"><div id="profile-progress-bar" class="progress-bar-fg h-2.5 rounded-full" style="width: 0%"></div></div><div id="profile-upload-status" class="text-sm text-center mt-1"></div></div></div>
                <div class="md:col-span-2 grid grid-cols-2 gap-4 items-center">
                    <div class="flex items-center"><label class="block mr-4">פרופיל פעיל</label><div class="relative inline-block w-12 mr-2 align-middle select-none"><input type="checkbox" name="toggle" id="profile-active" class="toggle-checkbox absolute block rounded-full bg-white border-4 appearance-none cursor-pointer" checked/><label for="profile-active" class="toggle-label block overflow-hidden rounded-full bg-gray-600 cursor-pointer"></label></div></div>
                    <div class="flex items-center"><label class="block mr-4">סדרן</label><div class="relative inline-block w-12 mr-2 align-middle select-none"><input type="checkbox" name="toggle-steward" id="profile-steward" class="toggle-checkbox absolute block rounded-full bg-white border-4 appearance-none cursor-pointer"/><label for="profile-steward" class="toggle-label block overflow-hidden rounded-full bg-gray-600 cursor-pointer"></label></div></div>
                </div>
            </div><div class="flex justify-end gap-4 mt-4"><button type="button" class="btn btn-secondary cancel-modal-btn">ביטול</button><button type="submit" id="save-profile-btn" class="btn btn-primary">שמור פרופיל</button></div></form></div></div>
    <div id="details-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-md text-center"><h3 id="details-modal-title" class="text-2xl font-bold mb-4" style="color: var(--primary-gold);"></h3><div id="details-modal-content" class="text-left space-y-2"></div><div id="details-modal-qr-code" class="flex justify-center my-6"></div><div class="text-center mt-6 flex justify-center gap-4"><button type="button" class="btn btn-secondary" id="close-details-modal">סגור</button><button type="button" class="btn btn-primary hidden" id="show-badge-btn">הצג תג</button></div></div></div>
    <div id="scanner-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-lg"><h3 class="text-2xl font-bold mb-6 text-center">סרוק קוד QR</h3><div id="reader" class="w-full bg-gray-800 rounded-lg overflow-hidden"></div><div class="text-center mt-4"><button type="button" class="btn btn-secondary" id="cancel-scanner-modal">סגור</button></div></div></div>
    <div id="qr-code-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden p-4">
        <div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h3 id="qr-modal-title" class="text-2xl font-bold mb-4" style="color: var(--primary-gold);">ברקוד עבור</h3>
            <div id="printable-qr-area" class="bg-white text-black p-4 rounded-md">
                <p id="qr-modal-name" class="text-xl font-bold mb-2"></p>
                <div id="qr-modal-code" class="flex justify-center"></div>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button type="button" class="btn btn-secondary cancel-modal-btn">סגור</button>
                <button type="button" id="download-qr-btn" class="btn btn-primary">הורד כתמונה</button>
            </div>
        </div>
    </div>
    <!-- Badge Modal -->
    <div id="badge-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-[60] hidden p-4">
        <div class="modal-content p-6 rounded-lg shadow-2xl w-full max-w-md text-center">
            <h3 class="text-2xl font-bold mb-4" style="color: var(--primary-gold);">תצוגה מקדימה של תג</h3>
            <div id="badge-design-area-wrapper" class="p-4 bg-gray-900 rounded-md">
                <div id="badge-design-area" class="bg-black text-white rounded-2xl aspect-[5.4/8.6] w-full max-w-xs mx-auto shadow-2xl overflow-hidden flex flex-col font-sans border-2 border-gray-700 relative">
                    <div class="absolute top-0 left-0 w-full h-2/5 opacity-50" style="background-image: linear-gradient(to bottom, var(--primary-gold), transparent);"></div>
                    <div class="flex-shrink-0 p-4 text-center z-10">
                        <img id="badge-logo" src="https://i.imgur.com/fYUvEiv.png" alt="Sayora Logo" class="w-28 h-28 mx-auto rounded-full" style="filter: drop-shadow(0 0 8px var(--primary-gold));">
                    </div>
                    <div class="flex-grow flex flex-col items-center justify-center text-center px-4 z-10 -mt-14">
                        <div class="w-32 h-32 rounded-full overflow-hidden border-4" style="border-color: var(--primary-gold);">
                            <img id="badge-photo" src="https://placehold.co/128x128/1E1E1E/E0E0E0?text=Photo" alt="Profile Photo" class="w-full h-full object-cover">
                        </div>
                        <h3 id="badge-name" class="mt-3 text-2xl font-bold tracking-wider" style="color: var(--primary-gold);">שם העובד</h3>
                        <p id="badge-role" class="text-base font-medium text-gray-300">תפקיד</p>
                    </div>
                    <div class="flex-shrink-0 p-3 bg-gray-900/70 z-10 flex items-center justify-between mt-auto">
                        <div>
                            <p class="text-xs text-gray-400">ID NUMBER</p>
                            <p id="badge-id-number" class="text-sm font-semibold">123456789</p>
                        </div>
                        <div class="text-right">
                           <p class="text-xs text-gray-400">PHONE</p>
                           <p id="badge-phone" class="text-sm font-semibold">050-0000000</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button type="button" class="btn btn-secondary" id="close-badge-modal">סגור</button>
                <button type="button" id="download-badge-btn" class="btn btn-primary">הורד</button>
                <button type="button" id="print-badge-btn" class="btn btn-primary">הדפס</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const firebaseConfig = { apiKey: "AIzaSyAUdX5OhKdNVvXTwVMF6zul6zGhldqx_s0", authDomain: "sayora-786c4.firebaseapp.com", projectId: "sayora-786c4", storageBucket: "sayora-786c4.firebasestorage.app", messagingSenderId: "353491525675", appId: "1:353491525675:web:0c59e5183e112e9bf84a6e" };
        const IMGBB_API_KEY = "1be5a3162de22aed0f431b25ffb4b6cb";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let html5QrcodeScanner;

        const mainContent = document.getElementById('main-content');
        const authModal = document.getElementById('auth-modal');
        const addUserModal = document.getElementById('add-user-modal');
        const userControls = document.getElementById('user-controls');
        const welcomeMessage = document.getElementById('welcome-message');
        const badgeModal = document.getElementById('badge-modal');

        const showLoading = (text = 'טוען...') => { document.getElementById('loading-overlay').style.display = 'flex'; document.getElementById('loading-text').textContent = text; }
        const hideLoading = () => document.getElementById('loading-overlay').style.display = 'none';
        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';

        // Auth State Change Listener
        onAuthStateChanged(auth, user => {
            if (user) {
                mainContent.style.display = 'block';
                userControls.style.display = 'flex';
                welcomeMessage.textContent = `ברוך הבא, ${user.displayName || user.email}`;
                closeModal(authModal);
                hideLoading();
            } else {
                mainContent.style.display = 'none';
                userControls.style.display = 'none';
                openModal(authModal);
                hideLoading();
            }
        });

        // Login Form
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = '';
            showLoading('מתחבר...');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                errorEl.textContent = 'שגיאה בהתחברות. בדוק אימייל וסיסמה.';
                hideLoading();
            }
        });

        // Logout Button
        document.getElementById('logout-btn').addEventListener('click', async () => {
            showLoading('מתנתק...');
            await signOut(auth);
        });
        
        // Add User Button & Form
        document.getElementById('add-user-btn').addEventListener('click', () => {
            document.getElementById('add-user-form').reset();
            document.getElementById('add-user-error').textContent = '';
            openModal(addUserModal);
        });
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const errorEl = document.getElementById('add-user-error');
            errorEl.textContent = '';
            const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;
            if (!passwordRegex.test(password)) {
                errorEl.textContent = 'הסיסמה לא עומדת בדרישות.';
                return;
            }
            showLoading('יוצר משתמש...');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: fullName });
                alert(`משתמש "${fullName}" נוצר בהצלחה!`);
                closeModal(addUserModal);
            } catch (error) {
                console.error("Failed to create user:", error);
                errorEl.textContent = error.code === 'auth/email-already-in-use' ? 'האימייל הזה כבר קיים במערכת.' : 'שגיאה ביצירת המשתמש.';
            } finally {
                hideLoading();
            }
        });

        document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal-backdrop').style.display = 'none'));
        document.getElementById('close-details-modal').addEventListener('click', () => closeModal(document.getElementById('details-modal')));
        
        // Image Upload Logic
        const uploadImageWithProgress = (file, progressElements) => {
            return new Promise((resolve, reject) => {
                const { container, bar, status } = progressElements;
                container.classList.remove('hidden'); status.textContent = 'ממיר תמונה...'; bar.style.width = '5%';
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    const formData = new FormData();
                    formData.append('key', IMGBB_API_KEY); formData.append('image', base64);
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', 'https://api.imgbb.com/1/upload');
                    xhr.upload.onprogress = (e) => { if (e.lengthComputable) { const percent = Math.min(95, 10 + (e.loaded / e.total) * 85); bar.style.width = `${percent}%`; status.textContent = `מעלה... ${Math.round(percent)}%`; } };
                    xhr.onload = () => {
                        try {
                            const json = JSON.parse(xhr.responseText);
                            if (xhr.status >= 200 && xhr.status < 300 && json.success) { bar.style.width = '100%'; status.textContent = 'העלאה הושלמה!'; resolve(json.data.display_url); } 
                            else { reject(new Error(json.error?.message || `שגיאת שרת: ${xhr.status}`)); }
                        } catch (err) { reject(new Error('תגובה לא תקינה מהשרת.')); }
                    };
                    xhr.onerror = () => reject(new Error('שגיאת רשת, לא ניתן להתחבר ל-ImgBB.'));
                    xhr.send(formData);
                };
                reader.onerror = () => reject(new Error('לא ניתן היה לקרוא את קובץ התמונה.'));
                reader.readAsDataURL(file);
            });
        };
        const handleImageSelection = async (e, formType) => {
            const file = e.target.files[0];
            const previewImg = document.getElementById(`${formType}-image-preview`);
            const filenameEl = document.getElementById(`${formType}-image-filename`);
            if (!file) { previewImg.src = 'https://placehold.co/64x64/2a2a2a/444444?text=בחר'; filenameEl.textContent = 'יש לבחור תמונה'; return; }
            previewImg.src = URL.createObjectURL(file); filenameEl.textContent = file.name;
            const saveBtn = document.getElementById(`save-${formType}-btn`);
            const imageUrlInput = document.getElementById(`${formType}-image-url`);
            const progressElements = { container: document.getElementById(`${formType}-upload-progress`), bar: document.getElementById(`${formType}-progress-bar`), status: document.getElementById(`${formType}-upload-status`) };
            saveBtn.disabled = true; saveBtn.textContent = 'מעלה תמונה...';
            imageUrlInput.value = ''; progressElements.status.textContent = ''; document.getElementById(`${formType}-image-status`).innerHTML = '';
            try {
                const url = await uploadImageWithProgress(file, progressElements);
                imageUrlInput.value = url;
                progressElements.status.innerHTML = `<span style="color: var(--primary-gold);">התמונה מוכנה לשמירה!</span>`;
            } catch (error) {
                console.error("Image upload failed:", error);
                progressElements.status.innerHTML = `<span class="text-red-500">שגיאה בהעלאה: ${error.message}</span>`;
                e.target.value = ''; 
            } finally { saveBtn.disabled = false; saveBtn.textContent = `שמור ${formType === 'profile' ? 'פרופיל' : 'מנהל'}`; }
        };
        document.getElementById('profile-image-input').addEventListener('change', (e) => handleImageSelection(e, 'profile'));
        document.getElementById('manager-image-input').addEventListener('change', (e) => handleImageSelection(e, 'manager'));
        
        // Generic Form Setup
        const setupForm = (form, modal, openBtn, collectionName, getFormData, openModalFn) => {
            openBtn.addEventListener('click', () => openModalFn());
            form.addEventListener('submit', async (e) => {
                e.preventDefault(); if (!form.checkValidity()) { form.reportValidity(); return; }
                const saveBtn = form.querySelector('button[type="submit"]');
                saveBtn.disabled = true; showLoading('שומר נתונים...');
                try {
                    const { data, id, needsImage } = getFormData();
                    if (needsImage && !data.imageUrl) throw new Error("יש להעלות תמונה לפני השמירה.");
                    if (id) await updateDoc(doc(db, collectionName, id), data); else await addDoc(collection(db, collectionName), data);
                    closeModal(modal);
                } catch (error) { console.error(`Error saving ${collectionName}:`, error); alert(`שגיאה בשמירת הנתונים: ${error.message}`);
                } finally { hideLoading(); saveBtn.disabled = false; }
            });
        };
        const openSiteModal = (site = null) => {
            const form = document.getElementById('site-form'); form.reset();
            document.getElementById('site-id').value = site ? site.id : '';
            document.getElementById('site-modal-title').textContent = site ? 'ערוך אתר' : 'הוסף אתר חדש';
            if(site) { document.getElementById('site-name').value = site.name; document.getElementById('site-details').value = site.details; }
            openModal(document.getElementById('site-modal'));
        };
        setupForm(document.getElementById('site-form'), document.getElementById('site-modal'), document.getElementById('add-site-btn'), 'sites', () => ({
            data: { name: document.getElementById('site-name').value, details: document.getElementById('site-details').value },
            id: document.getElementById('site-id').value
        }), () => openSiteModal());

        const resetImageUploader = (formType) => {
            document.getElementById(`${formType}-image-preview`).src = 'https://placehold.co/64x64/2a2a2a/444444?text=בחר';
            document.getElementById(`${formType}-image-filename`).textContent = 'יש לבחור תמונה';
            document.getElementById(`${formType}-image-input`).value = '';
            document.getElementById(`${formType}-image-status`).innerHTML = '';
            document.getElementById(`${formType}-upload-progress`).classList.add('hidden');
        };
        const openManagerModal = (manager = null) => {
            const form = document.getElementById('manager-form'); form.reset(); resetImageUploader('manager');
            const saveBtn = document.getElementById('save-manager-btn'); saveBtn.disabled = false; saveBtn.textContent = "שמור מנהל";
            document.getElementById('manager-id').value = manager ? manager.id : ''; document.getElementById('manager-modal-title').textContent = manager ? 'ערוך מנהל' : 'הוסף מנהל חדש';
            if (manager) {
                document.getElementById('manager-name').value = manager.name; document.getElementById('manager-phone').value = manager.phone; document.getElementById('manager-id-number').value = manager.idNumber; document.getElementById('manager-responsibility').value = manager.responsibility; document.getElementById('manager-image-url').value = manager.imageUrl || '';
                if(manager.imageUrl) { document.getElementById('manager-image-preview').src = manager.imageUrl; document.getElementById('manager-image-filename').textContent = 'תמונה קיימת'; document.getElementById('manager-image-status').innerHTML = `<a href="${manager.imageUrl}" target="_blank" style="color: var(--primary-gold);">הצג תמונה</a>`; }
                const siteIds = manager.sites.map(s => s.id); Array.from(document.getElementById('manager-sites').options).forEach(opt => opt.selected = siteIds.includes(opt.value));
            } openModal(document.getElementById('manager-modal'));
        };
        setupForm(document.getElementById('manager-form'), document.getElementById('manager-modal'), document.getElementById('add-manager-btn'), 'managers', () => {
            const sites = Array.from(document.getElementById('manager-sites').selectedOptions).map(opt => ({ id: opt.value, name: opt.textContent }));
            const data = { name: document.getElementById('manager-name').value, phone: document.getElementById('manager-phone').value, idNumber: document.getElementById('manager-id-number').value, responsibility: document.getElementById('manager-responsibility').value, sites, imageUrl: document.getElementById('manager-image-url').value };
            return { data, id: document.getElementById('manager-id').value, needsImage: true };
        }, () => openManagerModal());
        
        const openProfileModal = (profile = null) => { 
            const form = document.getElementById('profile-form'); form.reset(); resetImageUploader('profile');
            const saveBtn = document.getElementById('save-profile-btn'); saveBtn.disabled = false; saveBtn.textContent = "שמור פרופיל";
            document.getElementById('profile-id').value = profile ? profile.id : '';
            document.getElementById('profile-modal-title').textContent = profile ? 'ערוך פרופיל' : 'הוסף פרופיל חדש';
            document.getElementById('profile-active').checked = true;
            document.getElementById('profile-steward').checked = false;
            if (profile) {
                 document.getElementById('profile-name').value = profile.name; document.getElementById('profile-phone').value = profile.phone; document.getElementById('profile-id-number').value = profile.idNumber; document.getElementById('profile-role').value = profile.role;
                 document.getElementById('profile-active').checked = profile.isActive; document.getElementById('profile-steward').checked = profile.isSteward || false; document.getElementById('profile-image-url').value = profile.imageUrl || '';
                 if(profile.imageUrl) { document.getElementById('profile-image-preview').src = profile.imageUrl; document.getElementById('profile-image-filename').textContent = 'תמונה קיימת'; document.getElementById('profile-image-status').innerHTML = `<a href="${profile.imageUrl}" target="_blank" style="color: var(--primary-gold);">הצג תמונה</a>`; }
                 document.getElementById('profile-manager').value = profile.manager.id;
                 const siteIds = profile.sites.map(s => s.id); Array.from(document.getElementById('profile-sites').options).forEach(opt => opt.selected = siteIds.includes(opt.value));
            }
            openModal(document.getElementById('profile-modal'));
        };
        setupForm(document.getElementById('profile-form'), document.getElementById('profile-modal'), document.getElementById('add-profile-btn'), 'profiles', () => {
            const managerSelect = document.getElementById('profile-manager'); const manager = { id: managerSelect.value, name: managerSelect.options[managerSelect.selectedIndex].text }; const sites = Array.from(document.getElementById('profile-sites').selectedOptions).map(opt => ({ id: opt.value, name: opt.textContent }));
            const data = { name: document.getElementById('profile-name').value, phone: document.getElementById('profile-phone').value, idNumber: document.getElementById('profile-id-number').value, role: document.getElementById('profile-role').value, isActive: document.getElementById('profile-active').checked, isSteward: document.getElementById('profile-steward').checked, manager, sites, imageUrl: document.getElementById('profile-image-url').value };
            return { data, id: document.getElementById('profile-id').value, needsImage: true };
        }, () => openProfileModal());
        
        document.getElementById('select-all-manager-sites-btn').addEventListener('click', () => { Array.from(document.getElementById('manager-sites').options).forEach(o => o.selected = true); });
        document.getElementById('select-all-profile-sites-btn').addEventListener('click', () => { Array.from(document.getElementById('profile-sites').options).forEach(o => o.selected = true); });
        
        // Rendering Functions
        const renderSites = (sites) => {
            document.getElementById('sites-list').innerHTML = sites.length === 0 ? '<p class="text-gray-400">לא נמצאו אתרים.</p>' : sites.map(site => `<div class="item-card bg-gray-800 p-2 rounded-md flex justify-between items-center text-sm" data-type="site" data-id="${site.id}"><div><p class="font-semibold">${site.name}</p></div><div class="flex gap-2"><button class="card-btn edit-btn" data-type="site" data-id="${site.id}" title="ערוך">✏️</button><button class="card-btn delete-btn" data-type="site" data-id="${site.id}" title="מחק">🗑️</button></div></div>`).join('');
            const optionsHtml = sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.getElementById('manager-sites').innerHTML = optionsHtml; document.getElementById('profile-sites').innerHTML = optionsHtml;
        };
        const renderManagers = (managers) => { document.getElementById('managers-list').innerHTML = managers.length === 0 ? '<p class="text-gray-400">לא נמצאו מנהלים.</p>' : managers.map(m => `<div class="item-card bg-gray-800 p-2 rounded-md flex justify-between items-center text-sm" data-type="manager" data-id="${m.id}"><div class="flex items-center gap-2"><img src="${m.imageUrl || 'https://placehold.co/32x32'}" class="w-8 h-8 rounded-full object-cover"><p>${m.name}</p></div><div class="flex gap-1"><button class="card-btn qr-btn" data-type="manager" data-id="${m.id}" title="הצג ברקוד"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12h16M12 4v16m8-8H4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h2v2H4zm0 8h2v2H4zm8-8h2v2h-2zm0 8h2v2h-2zm8-8h2v2h-2zm0 8h2v2h-2zM4 4h2v2H4zm8 0h2v2h-2zm8 0h2v2h-2z"></path></svg></button><button class="card-btn edit-btn" data-type="manager" data-id="${m.id}" title="ערוך">✏️</button><button class="card-btn delete-btn" data-type="manager" data-id="${m.id}" title="מחק">🗑️</button></div></div>`).join(''); document.getElementById('profile-manager').innerHTML = `<option value="" disabled selected>בחר מנהל...</option>` + managers.map(m => `<option value="${m.id}">${m.name}</option>`).join(''); };
        const renderProfiles = (profiles) => {
            const profilesList = document.getElementById('profiles-list');
            if (profiles.length === 0) { profilesList.innerHTML = '<p class="text-gray-400 text-center col-span-full">לא נמצאו פרופילים.</p>'; return; }
            profilesList.innerHTML = profiles.map(p => {
                const activeBadge = p.isActive ? '<span class="text-xs text-green-400 bg-green-900 px-2 py-1 rounded-full">פעיל</span>' : '<span class="text-xs text-red-400 bg-red-900 px-2 py-1 rounded-full">לא פעיל</span>';
                const stewardBadge = p.isSteward ? '<span class="text-xs text-blue-400 bg-blue-800 px-2 py-1 rounded-full">סדרן</span>' : '';
                return `<div class="item-card bg-gray-800 p-4 rounded-lg flex items-start gap-4" data-type="profile" data-id="${p.id}"><img src="${p.imageUrl || 'https://placehold.co/64x64'}" alt="Profile" class="w-16 h-16 rounded-full object-cover"><div class="flex-grow"><h4 class="font-bold text-lg">${p.name}</h4><p class="text-sm" style="color:var(--primary-gold);">${p.role}</p><p class="text-xs text-gray-400 mt-1">אחראי: ${p.manager.name}</p><div class="mt-2 flex gap-2">${activeBadge} ${stewardBadge}</div></div><div class="flex flex-col gap-1"><button class="card-btn qr-btn" data-type="profile" data-id="${p.id}" title="הצג ברקוד"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4h2v2H4V4zm4 0h2v2H8V4zm4 0h2v2h-2V4zm-8 4h2v2H4V8zm4 0h2v2H8V8zm4 0h2v2h-2V8zM4 12h2v2H4v-2zm4 0h2v2H8v-2zm4 0h2v2h-2v-2z"></path></svg></button><button class="card-btn edit-btn" data-type="profile" data-id="${p.id}" title="ערוך">✏️</button><button class="card-btn delete-btn" data-type="profile" data-id="${p.id}" title="מחק">🗑️</button></div></div>`;
            }).join('');
        };
        
        // Show Details Modal
        const showDetails = (type, data) => {
            const titleEl = document.getElementById('details-modal-title');
            const contentEl = document.getElementById('details-modal-content');
            const qrEl = document.getElementById('details-modal-qr-code');
            const showBadgeBtn = document.getElementById('show-badge-btn');
            
            contentEl.innerHTML = ''; qrEl.innerHTML = ''; showBadgeBtn.classList.add('hidden');
            let contentHTML = '';

            if (type === 'site') {
                titleEl.textContent = 'פרטי אתר';
                contentHTML = `<p><strong>שם:</strong> ${data.name}</p><p><strong>פרטים:</strong> ${data.details || 'אין'}</p>`;
            } else {
                showBadgeBtn.classList.remove('hidden');
                const newBtn = showBadgeBtn.cloneNode(true);
                showBadgeBtn.parentNode.replaceChild(newBtn, showBadgeBtn);
                newBtn.addEventListener('click', () => showBadgeModal(data));
                
                const sitesHtml = data.sites.map(s => `<span class="bg-gray-700 text-gray-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${s.name}</span>`).join(' ');
                contentHTML = `<div class="flex items-center gap-4 mb-4"><img src="${data.imageUrl}" class="w-20 h-20 rounded-full object-cover border-2" style="border-color: var(--primary-gold);"><h4 class="text-xl font-bold">${data.name}</h4></div><p><strong>ת.ז.:</strong> ${data.idNumber}</p><p><strong>טלפון:</strong> ${data.phone}</p>`;
                
                if (type === 'manager') {
                    titleEl.textContent = 'פרטי מנהל'; contentHTML += `<p><strong>אחריות:</strong> ${data.responsibility}</p>`;
                } else {
                    titleEl.textContent = 'פרטי פרופיל'; contentHTML += `<p><strong>תפקיד:</strong> ${data.role}</p><p><strong>מנהל:</strong> ${data.manager.name}</p><p><strong>סטטוס:</strong> ${data.isActive ? '<span class="text-green-400">פעיל</span>' : '<span class="text-red-400">לא פעיל</span>'} ${data.isSteward ? '<span class="text-blue-400">סדרן</span>' : ''}</p>`;
                }
                contentHTML += `<div class="mt-2"><strong class="block mb-1">אתרים:</strong> ${sitesHtml}</div>`;
                const qrWrapper = document.createElement('div');
                qrWrapper.className = 'bg-white p-2 rounded-md inline-block';
                qrEl.appendChild(qrWrapper);
                new QRCode(qrWrapper, { text: data.id, width: 128, height: 128, colorDark: "#000000", colorLight: "#ffffff" });
            } 
            contentEl.innerHTML = contentHTML; 
            openModal(document.getElementById('details-modal'));
        };

        // QR Code Modals & Download
        const showQrCodeModal = (name, id) => {
            document.getElementById('qr-modal-name').textContent = name;
            const codeEl = document.getElementById('qr-modal-code');
            codeEl.innerHTML = '';
            new QRCode(codeEl, { text: id, width: 200, height: 200, colorDark : "#000000", colorLight : "#ffffff" });
            openModal(document.getElementById('qr-code-modal'));
        };
        document.getElementById('download-qr-btn').addEventListener('click', async () => {
            const area = document.getElementById('printable-qr-area');
            const name = document.getElementById('qr-modal-name').textContent;
            showLoading('יוצר תמונה...');
            try {
                const { default: html2canvas } = await import('https://cdn.skypack.dev/html2canvas');
                const canvas = await html2canvas(area, { backgroundColor: '#ffffff', scale: 3 });
                const link = document.createElement('a');
                link.download = `QR_Code_${name.replace(/\s/g, '_')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) { console.error("Failed to download QR code image:", err); alert("שגיאה בהורדת התמונה.");
            } finally { hideLoading(); }
        });

        // Badge Modal Functions
        const imageToDataUrl = (url) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL('image/png');
                    resolve(dataURL);
                };
                img.onerror = (err) => {
                    console.error('Image loading error:', url, err);
                    resolve(`https://placehold.co/${img.width || 128}x${img.height || 128}/1E1E1E/E0E0E0?text=Error`);
                };
                img.src = url;
            });
        };

        const showBadgeModal = async (data) => {
            showLoading('מכין תצוגה...');
            try {
                const logoUrl = 'https://i.imgur.com/fYUvEiv.png';
                const photoUrl = data.imageUrl || `https://placehold.co/128x128/1E1E1E/E0E0E0?text=${data.name.split(' ')[0]}`;
                
                const [logoDataUrl, photoDataUrl] = await Promise.all([
                    imageToDataUrl(logoUrl),
                    imageToDataUrl(photoUrl)
                ]);

                document.getElementById('badge-logo').src = logoDataUrl;
                document.getElementById('badge-photo').src = photoDataUrl;
                document.getElementById('badge-name').textContent = data.name;
                document.getElementById('badge-role').textContent = data.role || data.responsibility;
                document.getElementById('badge-id-number').textContent = data.idNumber;
                document.getElementById('badge-phone').textContent = data.phone;
                
                document.getElementById('download-badge-btn').dataset.name = data.name;
                openModal(badgeModal);
            } catch (error) {
                console.error("Error preparing badge:", error);
                alert("שגיאה בהכנת התג.");
            } finally {
                hideLoading();
            }
        };

        document.getElementById('close-badge-modal').addEventListener('click', () => closeModal(badgeModal));
        document.getElementById('print-badge-btn').addEventListener('click', () => window.print());
        document.getElementById('download-badge-btn').addEventListener('click', async (e) => {
            const area = document.getElementById('badge-design-area');
            const name = e.currentTarget.dataset.name || 'badge';
            showLoading('יוצר תמונה באיכות גבוהה...');
            try {
                const { default: html2canvas } = await import('https://cdn.skypack.dev/html2canvas');
                const canvas = await html2canvas(area, { 
                    backgroundColor: '#000000', 
                    scale: 6,
                    useCORS: true,
                    allowTaint: true 
                });
                const link = document.createElement('a');
                link.download = `Sayora_Badge_${name.replace(/\s/g, '_')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) { console.error("Failed to download badge image:", err); alert("שגיאה בהורדת התמונה.");
            } finally { hideLoading(); }
        });

        // Click Event Delegation for Cards and Buttons
        document.body.addEventListener('click', async (e) => {
            const button = e.target.closest('.edit-btn, .delete-btn, .qr-btn');
            if (button) {
                e.stopPropagation();
                const id = button.dataset.id; const type = button.dataset.type;
                const docRef = doc(db, `${type}s`, id);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) return;
                const data = { id: docSnap.id, ...docSnap.data() };
                if (button.classList.contains('edit-btn')) { if (type === 'site') openSiteModal(data); else if (type === 'manager') openManagerModal(data); else if (type === 'profile') openProfileModal(data); } 
                else if (button.classList.contains('delete-btn')) { if (confirm(`האם למחוק את הפריט?`)) await deleteDoc(docRef); } 
                else if (button.classList.contains('qr-btn')) { showQrCodeModal(data.name, data.id); }
                return;
            }
            const card = e.target.closest('.item-card');
            if (card) { 
                const id = card.dataset.id; const type = card.dataset.type; 
                const docSnap = await getDoc(doc(db, `${type}s`, id)); 
                if (docSnap.exists()) showDetails(type, { id, ...docSnap.data() }); 
            }
        });
        
        // QR Code Scanner Logic
        document.getElementById('scan-qr-btn').addEventListener('click', () => {
            openModal(document.getElementById('scanner-modal'));
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, async (decodedText) => {
                await html5QrcodeScanner.stop(); 
                closeModal(document.getElementById('scanner-modal')); 
                showLoading();
                try {
                    let docSnap = await getDoc(doc(db, "profiles", decodedText));
                    let type = 'profile';
                    if (!docSnap.exists()) { 
                        docSnap = await getDoc(doc(db, "managers", decodedText)); 
                        type = 'manager';
                    }
                    if (docSnap.exists()) {
                        showDetails(type, {id: docSnap.id, ...docSnap.data()});
                    } else { alert("לא נמצא פרופיל או מנהל תואם."); }
                } catch (err) { console.error("Error fetching doc by QR code:", err); alert("שגיאה באחזור המידע.");
                } finally { hideLoading(); }
            }, (error) => {});
        });
        document.getElementById('cancel-scanner-modal').addEventListener('click', () => { 
            if (html5QrcodeScanner && html5QrcodeScanner.getState() === 2) { html5QrcodeScanner.stop().catch(err => console.error("Error stopping scanner:", err)); }
            closeModal(document.getElementById('scanner-modal')); 
        });

        // Attach Firestore listeners
        onSnapshot(collection(db, "sites"), (snapshot) => renderSites(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        onSnapshot(collection(db, "managers"), (snapshot) => renderManagers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        onSnapshot(collection(db, "profiles"), (snapshot) => renderProfiles(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));

    </script>
</body>
</html>


