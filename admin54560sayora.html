<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sayora Festival - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-surface: #1E1E1E;
            --primary-gold: #c09a3e;
            --primary-gold-hover: #d4af37;
            --text-light: #E0E0E0;
            --border-color: #444444;
        }
        body { font-family: 'Assistant', sans-serif; background-color: var(--bg-dark); color: var(--text-light); }
        .modal-backdrop { background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: var(--bg-surface); border: 1px solid var(--border-color); max-height: 85vh; overflow-y: auto; }
        .form-input, .form-select, .form-textarea { background-color: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-light); border-radius: 0.5rem; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-gold); box-shadow: 0 0 0 2px rgba(192, 154, 62, 0.4); }
        .btn { border-radius: 0.5rem; font-weight: bold; padding: 0.6rem 1.2rem; transition: all 0.3s; cursor: pointer; }
        .btn-primary { background-color: var(--primary-gold); color: var(--bg-dark); }
        .btn-primary:hover { background-color: var(--primary-gold-hover); transform: translateY(-2px); }
        .btn-primary:disabled { background-color: #555; color: #999; cursor: not-allowed; transform: none; }
        .btn-secondary { background-color: #333; color: var(--text-light); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: #444; }
        .toggle-bg { transition: background-color 0.3s; }
        .toggle-checkbox:checked + .toggle-bg:after { transform: translateX(100%); }
        .toggle-checkbox:checked + .toggle-bg { background: var(--primary-gold); }
        .toggle-checkbox { width: 1.5rem; height: 1.5rem; }
        .toggle-label { width: 3rem; height: 1.5rem; }
        .toggle-label:after { content: ''; position: absolute; top: 2px; left: 2px; background: white; border-radius: 50%; transition: 0.3s; width: 20px; height: 20px; }
        .item-card { cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .item-card:hover { background-color: #2a2a2a; transform: translateY(-3px); }
        .progress-bar-bg { background-color: #333; }
        .progress-bar-fg { background-color: var(--primary-gold); transition: width 0.2s ease-in-out; }
        .image-uploader { background-color: #2a2a2a; border: 2px dashed var(--border-color); cursor: pointer; }
        .image-uploader:hover { border-color: var(--primary-gold); }
        .image-preview { width: 64px; height: 64px; object-fit: cover; border-radius: 0.375rem; }
        .card-btn { background: none; border: none; padding: 4px; border-radius: 50%; transition: background-color 0.2s; }
        .card-btn:hover { background-color: rgba(255,255,255,0.1); }
    </style>
</head>
<body class="antialiased">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex-col gap-4 justify-center items-center z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2" style="border-color: var(--primary-gold);"></div>
        <p id="loading-text" class="text-lg">טוען...</p>
    </div>
    
    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4">
        <div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <!-- START: Added Branding to Login Modal -->
            <div class="flex flex-col items-center gap-3 mb-6">
                <img src="https://i.imgur.com/fYUvEiv.png" alt="Sayora Festival Logo" class="w-20 h-20 rounded-full shadow-lg" style="box-shadow: 0 0 10px var(--primary-gold);">
                <h2 class="text-2xl font-bold text-white tracking-wider">SAYORA<span style="color: var(--primary-gold);"> FESTIVAL</span></h2>
                <p class="text-gray-400">התחברות למערכת הניהול</p>
            </div>
            <!-- END: Added Branding to Login Modal -->
            <form id="auth-form">
                <div class="mb-4">
                    <label for="auth-email" class="block mb-2">אימייל</label>
                    <input type="email" id="auth-email" class="w-full p-2 form-input" required>
                </div>
                <div class="mb-6">
                    <label for="auth-password" class="block mb-2">סיסמה</label>
                    <input type="password" id="auth-password" class="w-full p-2 form-input" required>
                </div>
                <p id="auth-error" class="text-red-500 text-center mb-4 h-4"></p>
                <button type="submit" class="btn btn-primary w-full">התחבר</button>
            </form>
        </div>
    </div>
    
    <div id="main-content" class="container mx-auto p-4 md:p-8" style="display: none;">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b-2 pb-6" style="border-color: var(--primary-gold);">
            <div class="flex items-center gap-4">
                <img src="https://i.imgur.com/fYUvEiv.png" alt="Sayora Festival Logo" class="w-20 h-20 md:w-24 md:h-24 rounded-full shadow-lg" style="box-shadow: 0 0 15px var(--primary-gold);">
                <h1 class="text-3xl md:text-5xl font-bold text-white tracking-wider">SAYORA<span style="color: var(--primary-gold);"> FESTIVAL</span></h1>
            </div>
            <div class="flex flex-col items-center gap-4 mt-6 md:mt-0">
                <div id="user-controls" class="hidden items-center gap-4">
                    <span id="welcome-message" class="text-lg"></span>
                    <button id="logout-btn" class="btn btn-secondary text-sm">התנתק</button>
                </div>
                <div class="flex items-center gap-4 mt-2">
                     <a href="index.html" class="btn btn-secondary text-lg">מעבר לדף הבית</a>
                     <button id="add-user-btn" class="btn btn-secondary text-lg">הוסף משתמש</button>
                     <button id="scan-qr-btn" class="btn btn-primary text-lg">סרוק ברקוד</button>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-transparent p-6 rounded-lg shadow-lg border border-gray-800">
                    <h2 class="text-2xl font-semibold mb-4" style="color: var(--primary-gold);">ניהול אתרים</h2>
                    <button id="add-site-btn" class="w-full btn btn-primary mb-4">הוסף אתר חדש</button>
                    <div id="sites-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
                <div class="bg-transparent p-6 rounded-lg shadow-lg border border-gray-800">
                    <h2 class="text-2xl font-semibold mb-4" style="color: var(--primary-gold);">ניהול מנהלים</h2>
                    <button id="add-manager-btn" class="w-full btn btn-primary mb-4">הוסף מנהל חדש</button>
                    <div id="managers-list" class="space-y-3 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            <div class="bg-transparent p-6 rounded-lg shadow-lg lg:col-span-2 border border-gray-800">
                <h2 class="text-2xl font-semibold mb-4" style="color: var(--primary-gold);">ניהול פרופילים</h2>
                <button id="add-profile-btn" class="w-full btn btn-primary mb-4">הוסף פרופיל חדש</button>
                 <div id="profiles-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[34rem] overflow-y-auto p-2"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="add-user-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4">
        <div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6">הוספת משתמש חדש</h3>
            <form id="add-user-form">
                <div class="mb-4">
                    <label for="new-user-name" class="block mb-2">שם מלא <span class="text-red-500">*</span></label>
                    <input type="text" id="new-user-name" class="w-full p-2 form-input" required>
                </div>
                <div class="mb-4">
                    <label for="new-user-email" class="block mb-2">אימייל <span class="text-red-500">*</span></label>
                    <input type="email" id="new-user-email" class="w-full p-2 form-input" required>
                </div>
                <div class="mb-6">
                    <label for="new-user-password" class="block mb-2">סיסמה <span class="text-red-500">*</span></label>
                    <input type="password" id="new-user-password" class="w-full p-2 form-input" required pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$">
                    <p class="text-xs text-gray-400 mt-1">חייב להכיל 8+ תווים, אותיות, מספר וסימן מיוחד (@$!%*#?&).</p>
                </div>
                <p id="add-user-error" class="text-red-500 text-center mb-4 h-4"></p>
                <div class="flex justify-end gap-4">
                    <button type="button" class="btn btn-secondary cancel-modal-btn">ביטול</button>
                    <button type="submit" class="btn btn-primary">הוסף משתמש</button>
                </div>
            </form>
        </div>
    </div>
    <div id="site-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-md"><h3 id="site-modal-title" class="text-2xl font-bold mb-6">הוסף אתר חדש</h3><form id="site-form"><input type="hidden" id="site-id"><div class="mb-4"><label for="site-name" class="block mb-2">שם האתר <span class="text-red-500">*</span></label><input type="text" id="site-name" class="w-full p-2 form-input" required></div><div class="mb-6"><label for="site-details" class="block mb-2">פירוט</label><textarea id="site-details" class="w-full p-2 form-textarea" rows="3"></textarea></div><div class="flex justify-end gap-4"><button type="button" class="btn btn-secondary cancel-modal-btn">ביטול</button><button type="submit" class="btn btn-primary">שמור</button></div></form></div></div>
    <div id="manager-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-lg"><h3 id="manager-modal-title" class="text-2xl font-bold mb-6">הוסף מנהל חדש</h3><form id="manager-form" novalidate><input type="hidden" id="manager-id"><input type="hidden" id="manager-image-url"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="manager-name" class="block mb-2">שם מלא <span class="text-red-500">*</span></label><input type="text" id="manager-name" class="w-full p-2 form-input" required></div><div><label for="manager-phone" class="block mb-2">מספר טלפון <span class="text-red-500">*</span></label><input type="tel" id="manager-phone" class="w-full p-2 form-input" required></div><div><label for="manager-id-number" class="block mb-2">תעודת זהות <span class="text-red-500">*</span></label><input type="text" id="manager-id-number" class="w-full p-2 form-input" required></div><div><div class="flex justify-between items-center mb-2"><label for="manager-sites">אתרים מורשים <span class="text-red-500">*</span></label><button type="button" class="text-xs btn-secondary py-1 px-2" id="select-all-manager-sites-btn">בחר הכל</button></div><select id="manager-sites" class="w-full p-2 form-select" multiple required></select></div><div class="md:col-span-2"><label for="manager-responsibility" class="block mb-2">אחריות <span class="text-red-500">*</span></label><textarea id="manager-responsibility" class="w-full p-2 form-textarea" rows="3" required></textarea></div><div class="md:col-span-2"><label class="block mb-2">תמונת פרופיל <span class="text-red-500">*</span></label><label for="manager-image-input" class="image-uploader p-4 rounded-lg flex items-center gap-4 w-full"><img id="manager-image-preview" src="https://placehold.co/64x64/2a2a2a/444444?text=בחר" alt="Preview" class="image-preview"><div class="flex-1"><p id="manager-image-filename" class="text-sm text-gray-400">יש לבחור תמונה</p><div id="manager-image-status" class="text-sm mt-1"></div></div></label><input type="file" id="manager-image-input" class="hidden" accept="image/*"><div id="manager-upload-progress" class="hidden mt-2"><div class="progress-bar-bg w-full rounded-full h-2.5"><div id="manager-progress-bar" class="progress-bar-fg h-2.5 rounded-full" style="width: 0%"></div></div><div id="manager-upload-status" class="text-sm text-center mt-1"></div></div></div></div><div class="flex justify-end gap-4 mt-6"><button type="button" class="btn btn-secondary cancel-modal-btn">ביטול</button><button type="submit" id="save-manager-btn" class="btn btn-primary">שמור מנהל</button></div></form></div></div>
    <div id="profile-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-lg"><h3 id="profile-modal-title" class="text-2xl font-bold mb-6">הוסף פרופיל חדש</h3><form id="profile-form" novalidate><input type="hidden" id="profile-id"><input type="hidden" id="profile-image-url"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="profile-name" class="block mb-2">שם מלא <span class="text-red-500">*</span></label><input type="text" id="profile-name" class="w-full p-2 form-input" required></div><div><label for="profile-phone" class="block mb-2">מספר טלפון <span class="text-red-500">*</span></label><input type="tel" id="profile-phone" class="w-full p-2 form-input" required></div><div><label for="profile-id-number" class="block mb-2">תעודת זהות <span class="text-red-500">*</span></label><input type="text" id="profile-id-number" class="w-full p-2 form-input" required></div><div><label for="profile-role" class="block mb-2">תפקיד <span class="text-red-500">*</span></label><input type="text" id="profile-role" class="w-full p-2 form-input" required></div><div><label for="profile-manager" class="block mb-2">מנהל אחראי <span class="text-red-500">*</span></label><select id="profile-manager" class="w-full p-2 form-select" required></select></div><div><div class="flex justify-between items-center mb-2"><label for="profile-sites" class="block">גישה לאתרים <span class="text-red-500">*</span></label><button type="button" class="text-xs btn-secondary py-1 px-2" id="select-all-profile-sites-btn">בחר הכל</button></div><select id="profile-sites" class="w-full p-2 form-select" multiple required></select></div><div class="md:col-span-2"><label class="block mb-2">תמונת פרופיל <span class="text-red-500">*</span></label><label for="profile-image-input" class="image-uploader p-4 rounded-lg flex items-center gap-4 w-full"><img id="profile-image-preview" src="https://placehold.co/64x64/2a2a2a/444444?text=בחר" alt="Preview" class="image-preview"><div class="flex-1"><p id="profile-image-filename" class="text-sm text-gray-400">יש לבחור תמונה</p><div id="profile-image-status" class="text-sm mt-1"></div></div></label><input type="file" id="profile-image-input" class="hidden" accept="image/*"><div id="profile-upload-progress" class="hidden mt-2"><div class="progress-bar-bg w-full rounded-full h-2.5"><div id="profile-progress-bar" class="progress-bar-fg h-2.5 rounded-full" style="width: 0%"></div></div><div id="profile-upload-status" class="text-sm text-center mt-1"></div></div></div>
                <div class="md:col-span-2 grid grid-cols-2 gap-4 items-center">
                    <div class="flex items-center"><label class="block mr-4">פרופיל פעיל</label><div class="relative inline-block w-12 mr-2 align-middle select-none"><input type="checkbox" name="toggle" id="profile-active" class="toggle-checkbox absolute block rounded-full bg-white border-4 appearance-none cursor-pointer" checked/><label for="profile-active" class="toggle-label block overflow-hidden rounded-full bg-gray-600 cursor-pointer"></label></div></div>
                    <div class="flex items-center"><label class="block mr-4">סדרן</label><div class="relative inline-block w-12 mr-2 align-middle select-none"><input type="checkbox" name="toggle-steward" id="profile-steward" class="toggle-checkbox absolute block rounded-full bg-white border-4 appearance-none cursor-pointer"/><label for="profile-steward" class="toggle-label block overflow-hidden rounded-full bg-gray-600 cursor-pointer"></label></div></div>
                </div>
            </div><div class="flex justify-end gap-4 mt-4"><button type="button" class="btn btn-secondary cancel-modal-btn">ביטול</button><button type="submit" id="save-profile-btn" class="btn btn-primary">שמור פרופיל</button></div></form></div></div>
    <div id="details-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-md text-center"><h3 id="details-modal-title" class="text-2xl font-bold mb-4" style="color: var(--primary-gold);"></h3><div id="details-modal-content" class="text-left space-y-2"></div><div id="details-modal-qr-code" class="flex justify-center my-6"></div><div class="text-center mt-4"><button type="button" class="btn btn-secondary" id="close-details-modal">סגור</button></div></div></div>
    <div id="scanner-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden p-4"><div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-lg"><h3 class="text-2xl font-bold mb-6 text-center">סרוק קוד QR</h3><div id="reader" class="w-full bg-gray-800 rounded-lg overflow-hidden"></div><div class="text-center mt-4"><button type="button" class="btn btn-secondary" id="cancel-scanner-modal">סגור</button></div></div></div>
    <div id="qr-code-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden p-4">
        <div class="modal-content p-8 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h3 id="qr-modal-title" class="text-2xl font-bold mb-4" style="color: var(--primary-gold);">ברקוד עבור</h3>
            <div id="printable-qr-area" class="bg-white text-black p-4 rounded-md">
                <p id="qr-modal-name" class="text-xl font-bold mb-2"></p>
                <div id="qr-modal-code" class="flex justify-center"></div>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button type="button" class="btn btn-secondary cancel-modal-btn">סגור</button>
                <button type="button" id="download-qr-btn" class="btn btn-primary">הורד כתמונה</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const firebaseConfig = { apiKey: "AIzaSyAUdX5OhKdNVvXTwVMF6zul6zGhldqx_s0", authDomain: "sayora-786c4.firebaseapp.com", projectId: "sayora-786c4", storageBucket: "sayora-786c4.firebasestorage.app", messagingSenderId: "353491525675", appId: "1:353491525675:web:0c59e5183e112e9bf84a6e" };
        const IMGBB_API_KEY = "1be5a3162de22aed0f431b25ffb4b6cb";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let html5QrcodeScanner;

        const mainContent = document.getElementById('main-content');
        const authModal = document.getElementById('auth-modal');
        const addUserModal = document.getElementById('add-user-modal');
        const userControls = document.getElementById('user-controls');
        const welcomeMessage = document.getElementById('welcome-message');

        const showLoading = (text = 'טוען...') => { document.getElementById('loading-overlay').style.display = 'flex'; document.getElementById('loading-text').textContent = text; }
        const hideLoading = () => document.getElementById('loading-overlay').style.display = 'none';
        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';

        // Auth State Change Listener
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in
                mainContent.style.display = 'block';
                userControls.style.display = 'flex';
                welcomeMessage.textContent = `ברוך הבא, ${user.displayName || user.email}`;
                closeModal(authModal);
                hideLoading();
            } else {
                // User is signed out
                mainContent.style.display = 'none';
                userControls.style.display = 'none';
                openModal(authModal);
                hideLoading();
            }
        });

        // Login Form
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = '';
            showLoading('מתחבר...');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the UI changes
            } catch (error) {
                console.error("Login failed:", error);
                errorEl.textContent = 'שגיאה בהתחברות. בדוק אימייל וסיסמה.';
                hideLoading();
            }
        });

        // Logout Button
        document.getElementById('logout-btn').addEventListener('click', async () => {
            showLoading('מתנתק...');
            await signOut(auth);
            // onAuthStateChanged will handle UI changes
        });
        
        // Add User Button
        document.getElementById('add-user-btn').addEventListener('click', () => {
            document.getElementById('add-user-form').reset();
            document.getElementById('add-user-error').textContent = '';
            openModal(addUserModal);
        });
        
        // Add User Form
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const errorEl = document.getElementById('add-user-error');
            errorEl.textContent = '';
            
            // Validate password with regex
            const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;
            if (!passwordRegex.test(password)) {
                errorEl.textContent = 'הסיסמה לא עומדת בדרישות.';
                return;
            }

            showLoading('יוצר משתמש...');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: fullName });
                alert(`משתמש "${fullName}" נוצר בהצלחה!`);
                closeModal(addUserModal);
            } catch (error) {
                console.error("Failed to create user:", error);
                if (error.code === 'auth/email-already-in-use') {
                    errorEl.textContent = 'האימייל הזה כבר קיים במערכת.';
                } else {
                    errorEl.textContent = 'שגיאה ביצירת המשתמש.';
                }
            } finally {
                hideLoading();
            }
        });


        document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal-backdrop').style.display = 'none'));
        document.getElementById('close-details-modal').addEventListener('click', () => closeModal(document.getElementById('details-modal')));
        
        // ... (Image Upload and Form Handling Logic - Unchanged)
        const uploadImageWithProgress = (file, progressElements) => {
            return new Promise((resolve, reject) => {
                const { container, bar, status } = progressElements;
                container.classList.remove('hidden'); status.textContent = 'ממיר תמונה...'; bar.style.width = '5%';
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    const formData = new FormData();
                    formData.append('key', IMGBB_API_KEY); formData.append('image', base64);
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', 'https://api.imgbb.com/1/upload');
                    xhr.upload.onprogress = (e) => { if (e.lengthComputable) { const percent = Math.min(95, 10 + (e.loaded / e.total) * 85); bar.style.width = `${percent}%`; status.textContent = `מעלה... ${Math.round(percent)}%`; } };
                    xhr.onload = () => {
                        try {
                            const json = JSON.parse(xhr.responseText);
                            if (xhr.status >= 200 && xhr.status < 300 && json.success) { bar.style.width = '100%'; status.textContent = 'העלאה הושלמה!'; resolve(json.data.display_url); } 
                            else { reject(new Error(json.error?.message || `שגיאת שרת: ${xhr.status}`)); }
                        } catch (err) { reject(new Error('תגובה לא תקינה מהשרת.')); }
                    };
                    xhr.onerror = () => reject(new Error('שגיאת רשת, לא ניתן להתחבר ל-ImgBB.'));
                    xhr.send(formData);
                };
                reader.onerror = () => reject(new Error('לא ניתן היה לקרוא את קובץ התמונה.'));
                reader.readAsDataURL(file);
            });
        };
        const handleImageSelection = async (e, formType) => {
            const file = e.target.files[0];
            const previewImg = document.getElementById(`${formType}-image-preview`);
            const filenameEl = document.getElementById(`${formType}-image-filename`);
            if (!file) { previewImg.src = 'https://placehold.co/64x64/2a2a2a/444444?text=בחר'; filenameEl.textContent = 'יש לבחור תמונה'; return; }
            previewImg.src = URL.createObjectURL(file); filenameEl.textContent = file.name;
            const saveBtn = document.getElementById(`save-${formType}-btn`);
            const imageUrlInput = document.getElementById(`${formType}-image-url`);
            const progressElements = { container: document.getElementById(`${formType}-upload-progress`), bar: document.getElementById(`${formType}-progress-bar`), status: document.getElementById(`${formType}-upload-status`) };
            saveBtn.disabled = true; saveBtn.textContent = 'מעלה תמונה...';
            imageUrlInput.value = ''; progressElements.status.textContent = ''; document.getElementById(`${formType}-image-status`).innerHTML = '';
            try {
                const url = await uploadImageWithProgress(file, progressElements);
                imageUrlInput.value = url;
                progressElements.status.innerHTML = `<span style="color: var(--primary-gold);">התמונה מוכנה לשמירה!</span>`;
            } catch (error) {
                console.error("Image upload failed:", error);
                progressElements.status.innerHTML = `<span class="text-red-500">שגיאה בהעלאה: ${error.message}</span>`;
                e.target.value = ''; 
            } finally { saveBtn.disabled = false; saveBtn.textContent = `שמור ${formType === 'profile' ? 'פרופיל' : 'מנהל'}`; }
        };
        document.getElementById('profile-image-input').addEventListener('change', (e) => handleImageSelection(e, 'profile'));
        document.getElementById('manager-image-input').addEventListener('change', (e) => handleImageSelection(e, 'manager'));
        const setupForm = (form, modal, openBtn, collectionName, getFormData, openModalFn) => {
            openBtn.addEventListener('click', () => openModalFn());
            form.addEventListener('submit', async (e) => {
                e.preventDefault(); if (!form.checkValidity()) { form.reportValidity(); return; }
                const saveBtn = form.querySelector('button[type="submit"]');
                saveBtn.disabled = true; showLoading('שומר נתונים...');
                try {
                    const { data, id, needsImage } = getFormData();
                    if (needsImage && !data.imageUrl) throw new Error("יש להעלות תמונה לפני השמירה.");
                    if (id) await updateDoc(doc(db, collectionName, id), data); else await addDoc(collection(db, collectionName), data);
                    closeModal(modal);
                } catch (error) { console.error(`Error saving ${collectionName}:`, error); alert(`שגיאה בשמירת הנתונים: ${error.message}`);
                } finally { hideLoading(); saveBtn.disabled = false; }
            });
        };
        const openSiteModal = (site = null) => {
            const form = document.getElementById('site-form'); form.reset();
            document.getElementById('site-id').value = site ? site.id : '';
            document.getElementById('site-modal-title').textContent = site ? 'ערוך אתר' : 'הוסף אתר חדש';
            if(site) { document.getElementById('site-name').value = site.name; document.getElementById('site-details').value = site.details; }
            openModal(document.getElementById('site-modal'));
        };
        const siteForm = document.getElementById('site-form');
        document.getElementById('add-site-btn').addEventListener('click', () => openSiteModal());
        siteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveBtn = siteForm.querySelector('button[type="submit"]');
            saveBtn.disabled = true; showLoading('שומר אתר...');
            try {
                const data = { name: document.getElementById('site-name').value, details: document.getElementById('site-details').value };
                const id = document.getElementById('site-id').value;
                if (id) await updateDoc(doc(db, 'sites', id), data); else await addDoc(collection(db, 'sites'), data);
                closeModal(document.getElementById('site-modal'));
            } catch (err) { alert('שגיאה בשמירת האתר.'); console.error(err); }
            finally { hideLoading(); saveBtn.disabled = false; }
        });
        const resetImageUploader = (formType) => {
            document.getElementById(`${formType}-image-preview`).src = 'https://placehold.co/64x64/2a2a2a/444444?text=בחר';
            document.getElementById(`${formType}-image-filename`).textContent = 'יש לבחור תמונה';
            document.getElementById(`${formType}-image-input`).value = '';
            document.getElementById(`${formType}-image-status`).innerHTML = '';
            document.getElementById(`${formType}-upload-progress`).classList.add('hidden');
        };
        const openManagerModal = (manager = null) => {
            const form = document.getElementById('manager-form'); form.reset(); resetImageUploader('manager');
            const saveBtn = document.getElementById('save-manager-btn'); saveBtn.disabled = false; saveBtn.textContent = "שמור מנהל";
            document.getElementById('manager-id').value = manager ? manager.id : ''; document.getElementById('manager-modal-title').textContent = manager ? 'ערוך מנהל' : 'הוסף מנהל חדש';
            if (manager) {
                document.getElementById('manager-name').value = manager.name; document.getElementById('manager-phone').value = manager.phone; document.getElementById('manager-id-number').value = manager.idNumber; document.getElementById('manager-responsibility').value = manager.responsibility; document.getElementById('manager-image-url').value = manager.imageUrl || '';
                if(manager.imageUrl) { document.getElementById('manager-image-preview').src = manager.imageUrl; document.getElementById('manager-image-filename').textContent = 'תמונה קיימת'; document.getElementById('manager-image-status').innerHTML = `<a href="${manager.imageUrl}" target="_blank" style="color: var(--primary-gold);">הצג תמונה</a>`; }
                const siteIds = manager.sites.map(s => s.id); Array.from(document.getElementById('manager-sites').options).forEach(opt => opt.selected = siteIds.includes(opt.value));
            } openModal(document.getElementById('manager-modal'));
        };
        setupForm(document.getElementById('manager-form'), document.getElementById('manager-modal'), document.getElementById('add-manager-btn'), 'managers', () => {
            const sites = Array.from(document.getElementById('manager-sites').selectedOptions).map(opt => ({ id: opt.value, name: opt.textContent }));
            const data = { name: document.getElementById('manager-name').value, phone: document.getElementById('manager-phone').value, idNumber: document.getElementById('manager-id-number').value, responsibility: document.getElementById('manager-responsibility').value, sites, imageUrl: document.getElementById('manager-image-url').value };
            return { data, id: document.getElementById('manager-id').value, needsImage: true };
        }, () => openManagerModal());
        
        const openProfileModal = (profile = null) => { 
             const form = document.getElementById('profile-form'); form.reset(); resetImageUploader('profile');
            const saveBtn = document.getElementById('save-profile-btn'); saveBtn.disabled = false; saveBtn.textContent = "שמור פרופיל";
            document.getElementById('profile-id').value = profile ? profile.id : '';
            document.getElementById('profile-modal-title').textContent = profile ? 'ערוך פרופיל' : 'הוסף פרופיל חדש';
            document.getElementById('profile-active').checked = true;
            document.getElementById('profile-steward').checked = false;
            if (profile) {
                 document.getElementById('profile-name').value = profile.name;
                 document.getElementById('profile-phone').value = profile.phone;
                 document.getElementById('profile-id-number').value = profile.idNumber;
                 document.getElementById('profile-role').value = profile.role;
                 document.getElementById('profile-active').checked = profile.isActive;
                 document.getElementById('profile-steward').checked = profile.isSteward || false;
                 document.getElementById('profile-image-url').value = profile.imageUrl || '';
                 if(profile.imageUrl) {
                    document.getElementById('profile-image-preview').src = profile.imageUrl;
                    document.getElementById('profile-image-filename').textContent = 'תמונה קיימת';
                    document.getElementById('profile-image-status').innerHTML = `<a href="${profile.imageUrl}" target="_blank" style="color: var(--primary-gold);">הצג תמונה</a>`;
                 }
                 document.getElementById('profile-manager').value = profile.manager.id;
                 const siteIds = profile.sites.map(s => s.id);
                 Array.from(document.getElementById('profile-sites').options).forEach(opt => opt.selected = siteIds.includes(opt.value));
            }
            openModal(document.getElementById('profile-modal'));
        };

        setupForm(document.getElementById('profile-form'), document.getElementById('profile-modal'), document.getElementById('add-profile-btn'), 'profiles', () => {
            const managerSelect = document.getElementById('profile-manager');
            const manager = { id: managerSelect.value, name: managerSelect.options[managerSelect.selectedIndex].text };
            const sites = Array.from(document.getElementById('profile-sites').selectedOptions).map(opt => ({ id: opt.value, name: opt.textContent }));
            const data = {
                name: document.getElementById('profile-name').value,
                phone: document.getElementById('profile-phone').value,
                idNumber: document.getElementById('profile-id-number').value,
                role: document.getElementById('profile-role').value,
                isActive: document.getElementById('profile-active').checked,
                isSteward: document.getElementById('profile-steward').checked,
                manager,
                sites,
                imageUrl: document.getElementById('profile-image-url').value
            };
            return { data, id: document.getElementById('profile-id').value, needsImage: true };
        }, () => openProfileModal());
        
        document.getElementById('select-all-manager-sites-btn').addEventListener('click', () => { Array.from(document.getElementById('manager-sites').options).forEach(o => o.selected = true); });
        document.getElementById('select-all-profile-sites-btn').addEventListener('click', () => { Array.from(document.getElementById('profile-sites').options).forEach(o => o.selected = true); });
        
        const renderSites = (sites) => {
            document.getElementById('sites-list').innerHTML = sites.length === 0 ? '<p class="text-gray-400">לא נמצאו אתרים.</p>' : sites.map(site => `<div class="item-card bg-gray-800 p-2 rounded-md flex justify-between items-center text-sm" data-type="site" data-id="${site.id}"><div><p class="font-semibold">${site.name}</p></div><div class="flex gap-2"><button class="card-btn edit-btn" data-type="site" data-id="${site.id}" title="ערוך">✏️</button><button class="card-btn delete-btn" data-type="site" data-id="${site.id}" title="מחק">🗑️</button></div></div>`).join('');
            const optionsHtml = sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.getElementById('manager-sites').innerHTML = optionsHtml;
            document.getElementById('profile-sites').innerHTML = optionsHtml;
        };
        const renderManagers = (managers) => { document.getElementById('managers-list').innerHTML = managers.length === 0 ? '<p class="text-gray-400">לא נמצאו מנהלים.</p>' : managers.map(m => `<div class="item-card bg-gray-800 p-2 rounded-md flex justify-between items-center text-sm" data-type="manager" data-id="${m.id}"><div class="flex items-center gap-2"><img src="${m.imageUrl || 'https://placehold.co/32x32'}" class="w-8 h-8 rounded-full object-cover"><p>${m.name}</p></div><div class="flex gap-1"><button class="card-btn qr-btn" data-type="manager" data-id="${m.id}" title="הצג ברקוד"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12h16M12 4v16m8-8H4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h2v2H4zm0 8h2v2H4zm8-8h2v2h-2zm0 8h2v2h-2zm8-8h2v2h-2zm0 8h2v2h-2zM4 4h2v2H4zm8 0h2v2h-2zm8 0h2v2h-2z"></path></svg></button><button class="card-btn edit-btn" data-type="manager" data-id="${m.id}" title="ערוך">✏️</button><button class="card-btn delete-btn" data-type="manager" data-id="${m.id}" title="מחק">🗑️</button></div></div>`).join(''); document.getElementById('profile-manager').innerHTML = `<option value="" disabled selected>בחר מנהל...</option>` + managers.map(m => `<option value="${m.id}">${m.name}</option>`).join(''); };
        const renderProfiles = (profiles) => {
            const profilesList = document.getElementById('profiles-list');
            if (profiles.length === 0) {
                profilesList.innerHTML = '<p class="text-gray-400 text-center col-span-full">לא נמצאו פרופילים.</p>';
                return;
            }
            profilesList.innerHTML = profiles.map(p => {
                const activeBadge = p.isActive 
                    ? '<span class="text-xs text-green-400 bg-green-900 px-2 py-1 rounded-full">פעיל</span>' 
                    : '<span class="text-xs text-red-400 bg-red-900 px-2 py-1 rounded-full">לא פעיל</span>';
                const stewardBadge = p.isSteward
                    ? '<span class="text-xs text-blue-400 bg-blue-800 px-2 py-1 rounded-full">סדרן</span>'
                    : '';
                return `<div class="item-card bg-gray-800 p-4 rounded-lg flex items-start gap-4" data-type="profile" data-id="${p.id}">
                    <img src="${p.imageUrl || 'https://placehold.co/64x64'}" alt="Profile" class="w-16 h-16 rounded-full object-cover">
                    <div class="flex-grow">
                        <h4 class="font-bold text-lg">${p.name}</h4>
                        <p class="text-sm" style="color:var(--primary-gold);">${p.role}</p>
                        <p class="text-xs text-gray-400 mt-1">אחראי: ${p.manager.name}</p>
                        <div class="mt-2 flex gap-2">${activeBadge} ${stewardBadge}</div>
                    </div>
                    <div class="flex flex-col gap-1">
                        <button class="card-btn qr-btn" data-type="profile" data-id="${p.id}" title="הצג ברקוד"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4h2v2H4V4zm4 0h2v2H8V4zm4 0h2v2h-2V4zm-8 4h2v2H4V8zm4 0h2v2H8V8zm4 0h2v2h-2V8zM4 12h2v2H4v-2zm4 0h2v2H8v-2zm4 0h2v2h-2v-2z"></path></svg></button>
                        <button class="card-btn edit-btn" data-type="profile" data-id="${p.id}" title="ערוך">✏️</button>
                        <button class="card-btn delete-btn" data-type="profile" data-id="${p.id}" title="מחק">🗑️</button>
                    </div>
                </div>`;
            }).join('');
        };
        const showDetails = (type, data) => {
            const titleEl = document.getElementById('details-modal-title');
            const contentEl = document.getElementById('details-modal-content');
            const qrEl = document.getElementById('details-modal-qr-code');
            contentEl.innerHTML = ''; qrEl.innerHTML = ''; let contentHTML = '';
            if (type === 'site') { titleEl.textContent = 'פרטי אתר'; contentHTML = `<p><strong>שם:</strong> ${data.name}</p><p><strong>פרטים:</strong> ${data.details || 'אין'}</p>`; } 
            else {
                const sitesHtml = data.sites.map(s => `<span class="bg-gray-700 text-gray-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${s.name}</span>`).join(' ');
                contentHTML = `<div class="flex items-center gap-4 mb-4"><img src="${data.imageUrl}" class="w-20 h-20 rounded-full object-cover border-2" style="border-color: var(--primary-gold);"><h4 class="text-xl font-bold">${data.name}</h4></div><p><strong>ת.ז.:</strong> ${data.idNumber}</p><p><strong>טלפון:</strong> ${data.phone}</p>`;
                if (type === 'manager') { titleEl.textContent = 'פרטי מנהל'; contentHTML += `<p><strong>אחריות:</strong> ${data.responsibility}</p>`; } 
                else { titleEl.textContent = 'פרטי פרופיל'; contentHTML += `<p><strong>תפקיד:</strong> ${data.role}</p><p><strong>מנהל:</strong> ${data.manager.name}</p><p><strong>סטטוס:</strong> ${data.isActive ? '<span class="text-green-400">פעיל</span>' : '<span class="text-red-400">לא פעיל</span>'} ${data.isSteward ? '<span class="text-blue-400">סדרן</span>' : ''}</p>`; }
                contentHTML += `<div class="mt-2"><strong class="block mb-1">אתרים:</strong> ${sitesHtml}</div>`;
                
                const qrWrapper = document.createElement('div');
                qrWrapper.className = 'bg-white p-2 rounded-md inline-block';
                qrEl.appendChild(qrWrapper);
                new QRCode(qrWrapper, { text: data.id, width: 128, height: 128, colorDark: "#000000", colorLight: "#ffffff" });
            } 
            contentEl.innerHTML = contentHTML; 
            openModal(document.getElementById('details-modal'));
        };

        const showQrCodeModal = (name, id) => {
            const modal = document.getElementById('qr-code-modal');
            const nameEl = document.getElementById('qr-modal-name');
            const codeEl = document.getElementById('qr-modal-code');
            nameEl.textContent = name;
            codeEl.innerHTML = '';
            new QRCode(codeEl, { text: id, width: 200, height: 200, colorDark : "#000000", colorLight : "#ffffff" });
            openModal(modal);
        };
        
        document.getElementById('download-qr-btn').addEventListener('click', async () => {
            const area = document.getElementById('printable-qr-area');
            const name = document.getElementById('qr-modal-name').textContent;
            showLoading('יוצר תמונה...');
            try {
                const { default: html2canvas } = await import('https://cdn.skypack.dev/html2canvas');
                const canvas = await html2canvas(area, { backgroundColor: '#ffffff', scale: 3 });
                const link = document.createElement('a');
                link.download = `QR_Code_${name.replace(/\s/g, '_')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                console.error("Failed to download QR code image:", err);
                alert("שגיאה בהורדת התמונה. נסה שוב.");
            } finally {
                hideLoading();
            }
        });

        document.body.addEventListener('click', async (e) => {
            const button = e.target.closest('.edit-btn, .delete-btn, .qr-btn');
            if (button) {
                e.stopPropagation();
                const id = button.dataset.id; const type = button.dataset.type;
                const docRef = doc(db, `${type}s`, id);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) return;
                const data = { id: docSnap.id, ...docSnap.data() };
                
                if (button.classList.contains('edit-btn')) {
                    if (type === 'site') openSiteModal(data); else if (type === 'manager') openManagerModal(data); else if (type === 'profile') openProfileModal(data);
                } else if (button.classList.contains('delete-btn')) { 
                    if (confirm(`האם למחוק את הפריט?`)) await deleteDoc(docRef);
                } else if (button.classList.contains('qr-btn')) {
                    showQrCodeModal(data.name, data.id);
                }
                return;
            }
            const card = e.target.closest('.item-card');
            if (card) { 
                const id = card.dataset.id; 
                const type = card.dataset.type; 
                const docRef = doc(db, `${type}s`, id);
                const docSnap = await getDoc(docRef); 
                if (docSnap.exists()) showDetails(type, { id, ...docSnap.data() }); 
            }
        });
        
        document.getElementById('scan-qr-btn').addEventListener('click', () => {
             openModal(document.getElementById('scanner-modal'));
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, async (decodedText) => {
                await html5QrcodeScanner.stop(); 
                closeModal(document.getElementById('scanner-modal')); 
                showLoading();
                try {
                    const profileSnap = await getDoc(doc(db, "profiles", decodedText));
                    if (profileSnap.exists()) {
                        showDetails('profile', {id: profileSnap.id, ...profileSnap.data()});
                    } else { 
                        const managerSnap = await getDoc(doc(db, "managers", decodedText)); 
                        if(managerSnap.exists()) {
                            showDetails('manager', {id: managerSnap.id, ...managerSnap.data()});
                        } else {
                            alert("לא נמצא פרופיל או מנהל תואם."); 
                        }
                    }
                } catch (err) {
                    console.error("Error fetching doc by QR code:", err);
                    alert("שגיאה באחזור המידע.");
                } finally {
                    hideLoading();
                }
            }, (error) => {});
        });
        document.getElementById('cancel-scanner-modal').addEventListener('click', () => { 
            if (html5QrcodeScanner && html5QrcodeScanner.getState() === 2) { // 2 is SCANNING state
                html5QrcodeScanner.stop().catch(err => console.error("Error stopping scanner:", err));
            }
            closeModal(document.getElementById('scanner-modal')); 
        });

        // Attach listeners to Firestore collections
        onSnapshot(collection(db, "sites"), (snapshot) => renderSites(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        onSnapshot(collection(db, "managers"), (snapshot) => renderManagers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        onSnapshot(collection(db, "profiles"), (snapshot) => renderProfiles(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));

    </script>
</body>
</html>


